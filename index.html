<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¡°ë¦¬ê°ˆë¦¬</title>
    <!-- ìµœì‹  ë²„ì „ì˜ PeerJS ì‚¬ìš© -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë° ë¦¬ì…‹ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Jua', 'Noto Sans KR', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #FFC3A0 0%, #FFAFBD 100%);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* ê²Œì„ ì»¨í…Œì´ë„ˆ */
        .game-container {
            width: 95%;
            max-width: 1200px;
            height: 95vh;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            transition: all 0.5s ease;
        }

        /* í—¤ë” */
        .game-header {
            background: linear-gradient(90deg, #FF6B6B 0%, #FF8E53 100%);
            color: white;
            padding: 12px 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            z-index: 10;
        }

        h1 {
            font-size: 2.8rem;
            margin: 0;
            letter-spacing: 3px;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* ê²Œì„ í™”ë©´ */
        .game-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            padding: 15px;
            overflow: hidden;
        }

        /* ì ‘ì† í™”ë©´ */
        .connection-screen {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
            text-align: center;
            padding: 0 20px;
        }

        .connection-screen h2 {
            font-size: 1.8rem;
            color: #FF6B6B;
            margin-bottom: 5px;
        }

        .connection-screen p {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #555;
        }

        .connection-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 450px;
        }

        .connection-screen button, .ready-btn {
            background: linear-gradient(90deg, #FF8E53 0%, #FF6B6B 100%);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 12px 25px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            white-space: nowrap;
        }

        .connection-screen button:hover, .ready-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.5);
        }

        .connection-screen button:active, .ready-btn:active {
            transform: translateY(1px);
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.3);
        }

        .connection-screen input, .chat-input {
            border: 2px solid #FFB6C1;
            border-radius: 30px;
            padding: 12px 20px;
            font-size: 1.1rem;
            width: 100%;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .connection-screen input:focus, .chat-input:focus {
            border-color: #FF6B6B;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.2);
        }

        .join-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* ëŒ€ê¸° í™”ë©´ */
        .waiting-screen {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 30px;
            text-align: center;
            display: none;
            opacity: 0;
        }

        .waiting-screen h2 {
            font-size: 2.2rem;
            color: #FF6B6B;
            margin-bottom: 10px;
        }

        .ready-status {
            font-size: 1.5rem;
            margin: 15px 0;
            background-color: rgba(255, 250, 240, 0.8);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        .ready-status p {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
        }

        .ready-status span.yes {
            color: #27ae60;
            font-weight: bold;
        }

        .ready-status span.no {
            color: #e74c3c;
        }

        /* ê²Œì„ í”Œë ˆì´ ì˜ì—­ */
        .gameplay-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            padding: 15px 0;
            display: none;
            opacity: 0;
            overflow: hidden;
        }

        .player-area {
            height: 40%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.5s ease;
            padding: 10px 5px;
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 8px 15px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin: 5px 0;
        }

        .turn-indicator {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 1rem;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }

        .turn-indicator.active {
            opacity: 1;
        }

        .opponent-area {
            border-bottom: 2px dashed rgba(255, 107, 107, 0.3);
        }

        .player-self-area {
            border-top: 2px dashed rgba(255, 107, 107, 0.3);
        }

        .card-area {
            display: flex;
            justify-content: center;
            width: 100%;
            position: relative;
            height: 180px;
        }

        .player-active-card, .opponent-active-card {
            position: absolute;
            width: 130px;
            height: 180px;
            perspective: 1000px;
            z-index: 10;
        }

        .player-active-card {
            top: -20px;
        }

        .opponent-active-card {
            bottom: -20px;
        }

        /* ì¤‘ì•™ ì˜ì—­ */
        .center-area {
            height: 20%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card {
            width: 130px;
            height: 180px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            border: 3px solid #FFE5E5;
            transform: scale(0.9); /* ì¹´ë“œ í¬ê¸° ì•½ê°„ ì¤„ì„ */
        }

        .card-back {
            background: linear-gradient(45deg, #FF6B6B 0%, #FFB88C 100%);
            color: white;
            font-size: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            position: absolute;
            backface-visibility: hidden;
            transform: rotateY(180deg);
        }

        .card-front {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            background-color: #FFFAF0;
        }

        .card-content {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            padding: 5px;
            overflow: hidden; /* ì´ëª¨ì§€ê°€ ì¹´ë“œ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ */
        }

        .fruit-item {
            font-size: 1.5rem; /* ì´ëª¨ì§€ í¬ê¸° ì¤„ì„ */
            margin: 2px;
            filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.2));
            transition: all 0.2s ease;
            display: inline-block;
        }

        .card:hover .fruit-item {
            transform: scale(1.05);
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            transform: translateY(-5px) scale(0.9);
        }

        /* ì¢… ìŠ¤íƒ€ì¼ */
        .bell {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 50%;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3), inset 0 -5px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 50;
            border: 5px solid rgba(255, 255, 255, 0.7);
        }

        .bell::before {
            content: 'ğŸ””';
            font-size: 3.5rem;
            filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.2));
        }

        .bell:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4), inset 0 -5px 10px rgba(0, 0, 0, 0.2);
        }

        .bell:active, .bell.ringing {
            transform: scale(0.95);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2), inset 0 -3px 5px rgba(0, 0, 0, 0.2);
        }

        .bell.ringing {
            animation: ring 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
        }

        @keyframes ring {
            0%, 100% { transform: scale(0.95); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(-10deg) scale(0.95); }
            20%, 40%, 60%, 80% { transform: rotate(10deg) scale(1); }
        }

        /* ì¹´ë“œ ë± ìŠ¤íƒ€ì¼ */
        .deck {
            position: relative;
            width: 130px;
            height: 180px;
            margin: 20px;
            perspective: 1000px;
        }

        .deck-stack {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .deck-card {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #FF6B6B 0%, #FFB88C 100%);
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 3px solid white;
        }

        .deck-card:nth-child(1) { transform: translateZ(-2px) translateX(2px) translateY(2px); }
        .deck-card:nth-child(2) { transform: translateZ(-4px) translateX(4px) translateY(4px); }
        .deck-card:nth-child(3) { transform: translateZ(-6px) translateX(6px) translateY(6px); }

        .deck-count {
            position: absolute;
            top: -15px;
            right: -15px;
            background-color: #FF6B6B;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 20;
            border: 3px solid white;
        }

        /* ë©”ì‹œì§€ ì‹œìŠ¤í…œ */
        .message-container {
            position: absolute;
            top: 80px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            pointer-events: none;
        }

        .game-message {
            background-color: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 1.3rem;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .game-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* ì¹´ìš´íŠ¸ë‹¤ìš´ */
        .countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10rem;
            font-weight: bold;
            color: #FF6B6B;
            opacity: 0;
            z-index: 100;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        }

        .countdown.show {
            animation: countdownAnim 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes countdownAnim {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(2); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
        }

        /* ì±„íŒ… ì‹œìŠ¤í…œ */
        .chat-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 320px;
            height: 450px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 200;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: translateX(350px);
            border: 2px solid #FFE5E5;
        }

        .chat-container.open {
            transform: translateX(0);
        }

        .chat-header {
            background: linear-gradient(90deg, #FF8E53 0%, #FF6B6B 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background-color: #FFF5F5;
        }

        .chat-message {
            padding: 10px 15px;
            border-radius: 20px;
            max-width: 80%;
            word-break: break-word;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.sent {
            background-color: #FF8E53;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .chat-message.received {
            background-color: white;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .chat-input-container {
            display: flex;
            padding: 15px;
            background-color: white;
            border-top: 1px solid #FFE5E5;
        }

        .chat-input {
            flex: 1;
            margin-right: 10px;
            padding: 12px 15px;
            border-radius: 25px;
            border: 2px solid #FFE5E5;
            background-color: #FFF5F5;
            font-size: 1rem;
        }

        .send-btn {
            background: linear-gradient(90deg, #FF8E53 0%, #FF6B6B 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.3);
            font-size: 1.2rem;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        /* ì—¬ê¸°ì„œ ë²„íŠ¼ ê²¹ì¹¨ ë¬¸ì œë¥¼ í•´ê²° */
        .chat-toggle {
            position: fixed; 
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            background: linear-gradient(90deg, #FF8E53 0%, #FF6B6B 100%);
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 201;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 3px solid white;
        }

        .chat-toggle:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        /* ì±„íŒ…ì°½ì´ ì—´ë ¤ìˆì„ ë•ŒëŠ” ì±„íŒ… í† ê¸€ ë²„íŠ¼ì„ ìœ„ë¡œ ì´ë™ */
        .chat-container.open + .chat-toggle {
            bottom: 480px; 
            right: 25px;
            transform: scale(0.8); 
        }

        /* ì¡°ì‘ë²• */
        .controls {
            position: absolute;
            bottom: 25px;
            left: 25px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            border: 2px solid #FFE5E5;
            animation: float 5s infinite ease-in-out;
            z-index: 150; 
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .controls h3 {
            margin-bottom: 15px;
            color: #FF6B6B;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .controls h3::before {
            content: "ğŸ®";
            font-size: 1.5rem;
        }

        .controls ul {
            list-style-type: none;
            padding-left: 5px;
        }

        .controls li {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .controls .key {
            background-color: #FFF5F5;
            border: 2px solid #FFE5E5;
            border-radius: 8px;
            padding: 5px 10px;
            margin-right: 15px;
            font-weight: bold;
            display: inline-block;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
            color: #FF6B6B;
            min-width: 70px;
            text-align: center;
        }

        .controls p {
            margin-top: 15px;
            font-size: 0.95rem;
            line-height: 1.5;
            padding: 10px;
            background-color: #FFF5F5;
            border-radius: 10px;
            border-left: 3px solid #FF6B6B;
        }

        /* ìŠ¤í¬ë¦° ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ */
        .connection-screen, .waiting-screen, .gameplay-screen {
            opacity: 0;
            display: none;
            transition: opacity 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .screen-active {
            opacity: 1;
            display: flex;
        }

        /* ë¡œì»¬ ê²Œì„ í”Œë ˆì´ì–´ êµ¬ë¶„ ì˜ì—­ */
        .player-area.player1 {
            border-bottom: 2px dashed rgba(255, 107, 107, 0.3);
            border-left: 5px solid #27ae60; /* í”Œë ˆì´ì–´ 1 êµ¬ë¶„ ìƒ‰ìƒ */
        }

        .player-area.player2 {
            border-top: 2px dashed rgba(255, 107, 107, 0.3);
            border-left: 5px solid #3498db; /* í”Œë ˆì´ì–´ 2 êµ¬ë¶„ ìƒ‰ìƒ */
        }

        /* ë¡œì»¬ ê²Œì„ í”Œë ˆì´ì–´ ì •ë³´ */
        .player-area.player1 .player-info span:first-child {
            color: #27ae60;
            font-weight: bold;
        }

        .player-area.player2 .player-info span:first-child {
            color: #3498db;
            font-weight: bold;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .game-container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }

            h1 {
                font-size: 2.2rem;
            }

            .player-area {
                height: 38%;
            }

            .center-area {
                height: 24%;
            }

            .bell {
                width: 80px;
                height: 80px;
            }

            .bell::before {
                font-size: 2.8rem;
            }

            .chat-container {
                width: 100%;
                height: 60vh;
                bottom: 0;
                right: 0;
                border-radius: 20px 20px 0 0;
                transform: translateY(100%);
            }

            .chat-container.open {
                transform: translateY(0);
            }

            .chat-toggle {
                bottom: 20px;
                right: 20px;
            }

            .chat-container.open + .chat-toggle {
                bottom: 62vh;
                right: 20px;
            }

            .controls {
                bottom: 20px;
                left: 20px;
                max-width: calc(100% - 100px);
            }
        }

        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .loader {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            z-index: 1000;
        }

        .loader.active {
            display: block;
        }

        .loader-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 10px solid transparent;
            border-top-color: #FF6B6B;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loader-inner {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            bottom: 15px;
            border: 10px solid transparent;
            border-top-color: #FF8E53;
            border-radius: 50%;
            animation: spin 0.8s linear infinite reverse;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ì˜¤ë¥˜ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .error-message {
            background-color: rgba(231, 76, 60, 0.85); 
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            animation: fadeIn 0.3s ease;
        }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .local-play-btn, .local-multi-btn {
            margin-top: 20px;
        }
        
        .local-play-btn {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
        }
        
        .local-multi-btn {
            background: linear-gradient(90deg, #3498db, #2980b9);
        }
        
        /* ê²Œì„ ì„¤ëª… */
        .game-description {
            margin-top: 15px;
            padding: 12px;
            background-color: #FFF5F5;
            border-radius: 15px;
            border-left: 4px solid #FF6B6B;
            max-width: 600px;
            text-align: left;
            font-size: 1rem;
            line-height: 1.4;
            color: #555;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        /* ê²Œì„ ì½”ë“œ í‘œì‹œ */
        #peer-id-container {
            margin-top: 15px;
            padding: 10px;
            background-color: #FFF5F5;
            border-radius: 15px;
            border: 2px dashed #FF6B6B;
            max-width: 400px;
            text-align: center;
            animation: pulse 2s infinite ease-in-out;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
        }
        
        #peer-id {
            font-size: 3rem;
            color: #FF6B6B;
            margin: 5px 0;
            display: block;
            letter-spacing: 5px;
        }
        
        /* ì—°ê²° ìƒíƒœ ë©”ì‹œì§€ */
        #connection-status {
            margin-top: 15px;
            padding: 10px 15px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            font-weight: bold;
            color: #FF6B6B;
            max-width: 90%;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1>ğŸ“ ì¡°ë¦¬ê°ˆë¦¬ ğŸŒ</h1>
        </div>

        <div class="game-screen">
            <!-- ë©”ì‹œì§€ ì‹œìŠ¤í…œ -->
            <div class="message-container">
                <div class="game-message"></div>
            </div>

            <!-- ì¹´ìš´íŠ¸ë‹¤ìš´ -->
            <div class="countdown"></div>

            <!-- ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ -->
            <div class="loader" id="loader">
                <div class="loader-circle"></div>
                <div class="loader-inner"></div>
            </div>

            <!-- ì ‘ì† í™”ë©´ -->
            <div class="connection-screen screen-active">
                <h2>ğŸ® ì¡°ë¦¬ê°ˆë¦¬ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! ğŸ®</h2>
                <p class="game-description">
                    <strong>ğŸ² ê²Œì„ ë°©ë²•:</strong> ê°™ì€ ê³¼ì¼ì´ <strong>ì •í™•íˆ 5ê°œ</strong> ìˆì„ ë•Œ ì¢…ì„ ì¹˜ì„¸ìš”!<br>
                    ê° í”Œë ˆì´ì–´ëŠ” í„´ë§ˆë‹¤ ì¹´ë“œë¥¼ ë‚´ê³ , ë‘ ì¥ì˜ ì¹´ë“œì— ìˆëŠ” ê°™ì€ ì¢…ë¥˜ì˜ ê³¼ì¼ì´ ì´ 5ê°œê°€ ë˜ë©´ ì¢…ì„ ì³ì„œ ì¹´ë“œë¥¼ ëª¨ë‘ ê°€ì ¸ê°‘ë‹ˆë‹¤.<br>
                    ì˜ëª» ì¢…ì„ ì¹˜ë©´ ìƒëŒ€ë°©ì—ê²Œ ì¹´ë“œ 2ì¥ì„ ì¤˜ì•¼ í•©ë‹ˆë‹¤. ëª¨ë“  ì¹´ë“œë¥¼ ê°€ì§„ í”Œë ˆì´ì–´ê°€ ìŠ¹ë¦¬í•©ë‹ˆë‹¤!
                </p>
                <div class="connection-options">
                    <button id="create-btn">ğŸŒ ì˜¨ë¼ì¸: ìƒˆ ê²Œì„ ë§Œë“¤ê¸°</button>
                    <div class="join-container">
                        <input type="text" id="join-id" placeholder="3ìë¦¬ ê²Œì„ ì½”ë“œ ì…ë ¥" maxlength="3" pattern="[0-9]*" inputmode="numeric">
                        <button id="join-btn">ğŸŒ ì˜¨ë¼ì¸: ê²Œì„ ì°¸ì—¬í•˜ê¸°</button>
                    </div>
                    <button id="local-multi-btn" class="local-multi-btn">ğŸ‘¥ ë¡œì»¬: 2ì¸ í”Œë ˆì´</button>
                    <button id="local-play-btn" class="local-play-btn">ğŸ–¥ï¸ ë¡œì»¬: ì»´í“¨í„°ì™€ í”Œë ˆì´</button>
                </div>
                <div id="peer-id-container" style="margin-top: 20px; display: none;">
                    <p>ë‹¹ì‹ ì˜ ê²Œì„ ì½”ë“œ: <span id="peer-id" style="font-weight: bold; font-size: 2.5rem; color: #FF6B6B;"></span></p>
                    <p>ì´ 3ìë¦¬ ì½”ë“œë¥¼ ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ì„¸ìš”! ğŸ“±</p>
                </div>
                <div id="connection-status" style="margin-top: 20px; color: #FF6B6B; font-weight: bold;"></div>
            </div>

            <!-- ëŒ€ê¸° í™”ë©´ -->
            <div class="waiting-screen">
                <h2>ğŸ² ê²Œì„ ì¤€ë¹„ ğŸ²</h2>
                <div class="ready-status">
                    <p>ë‚˜: <span id="my-ready" class="no">ì¤€ë¹„ ì•ˆë¨ âŒ</span></p>
                    <p>ìƒëŒ€ë°©: <span id="opponent-ready" class="no">ì¤€ë¹„ ì•ˆë¨ âŒ</span></p>
                </div>
                <button class="ready-btn" id="ready-btn">âœ… ì¤€ë¹„ ì™„ë£Œ</button>
                <button class="ready-btn" id="back-btn" style="background: linear-gradient(90deg, #888, #555); margin-top: 15px;">ğŸ”™ ë©”ì¸ í™”ë©´ìœ¼ë¡œ</button>
            </div>

            <!-- ê²Œì„ í”Œë ˆì´ í™”ë©´ -->
            <div class="gameplay-screen">
                <!-- ìƒëŒ€ë°©/í”Œë ˆì´ì–´1 ì˜ì—­ -->
                <div class="player-area opponent-area player1">
                    <div class="turn-indicator opponent-turn">ğŸ‘‰ ìƒëŒ€ë°© ì°¨ë¡€ì…ë‹ˆë‹¤!</div>
                    <div class="player-info">
                        <span id="player1-name">ğŸ§‘â€ğŸ¤â€ğŸ§‘ ìƒëŒ€ë°©</span>
                        <span>ë‚¨ì€ ì¹´ë“œ: <span id="opponent-cards">25</span>ì¥ ğŸƒ</span>
                    </div>
                    <div class="card-area">
                        <div class="deck">
                            <div class="deck-stack">
                                <div class="deck-card"></div>
                                <div class="deck-card"></div>
                                <div class="deck-card"></div>
                            </div>
                            <div class="deck-count" id="opponent-deck-count">25</div>
                        </div>
                        <div class="opponent-active-card">
                            <!-- ìƒëŒ€ë°©/í”Œë ˆì´ì–´1ì˜ í™œì„± ì¹´ë“œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </div>

                <!-- ì¤‘ì•™ ì˜ì—­ (ì¢…) -->
                <div class="center-area">
                    <div class="bell" id="bell"></div>
                </div>

                <!-- í”Œë ˆì´ì–´/í”Œë ˆì´ì–´2 ì˜ì—­ -->
                <div class="player-area player-self-area player2">
                    <div class="turn-indicator player-turn">ğŸ‘‰ ë‹¹ì‹ ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤!</div>
                    <div class="card-area">
                        <div class="player-active-card">
                            <!-- í”Œë ˆì´ì–´/í”Œë ˆì´ì–´2ì˜ í™œì„± ì¹´ë“œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                        <div class="deck">
                            <div class="deck-stack">
                                <div class="deck-card"></div>
                                <div class="deck-card"></div>
                                <div class="deck-card"></div>
                            </div>
                            <div class="deck-count" id="player-deck-count">25</div>
                        </div>
                    </div>
                    <div class="player-info">
                        <span id="player2-name">ğŸ‘¤ ë‚˜</span>
                        <span>ë‚¨ì€ ì¹´ë“œ: <span id="player-cards">25</span>ì¥ ğŸƒ</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì¡°ì‘ë²• ê°€ì´ë“œ -->
        <div class="controls">
            <h3>ì¡°ì‘ë²•</h3>
            <ul id="controls-list">
                <li><span class="key">â†‘</span> ì¹´ë“œ ë‚´ê¸°</li>
                <li><span class="key">Space</span> ì¢… ì¹˜ê¸°</li>
            </ul>
            <p id="controls-desc">
                ğŸ”” ê°™ì€ ê³¼ì¼ì´ ì •í™•íˆ 5ê°œ ìˆì„ ë•Œ ì¢…ì„ ì³ì•¼ í•©ë‹ˆë‹¤!<br>
                âš ï¸ ì˜ëª» ì¢…ì„ ì¹˜ë©´ ìƒëŒ€ë°©ì—ê²Œ ì¹´ë“œ 2ì¥ì„ ì¤˜ì•¼ í•©ë‹ˆë‹¤.
            </p>
        </div>

        <!-- ì±„íŒ… ì»¨í…Œì´ë„ˆ -->
        <div class="chat-container">
            <div class="chat-header">ğŸ’¬ ì±„íŒ…</div>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
                <button class="send-btn" id="send-chat">ğŸ“¨</button>
            </div>
        </div>
        
        <!-- ì±„íŒ… í† ê¸€ ë²„íŠ¼ -->
        <button class="chat-toggle" id="chat-toggle">ğŸ’¬</button>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        let peer; // PeerJS ê°ì²´
        let conn; // í”¼ì–´ ì—°ê²°
        let playerId; // í”Œë ˆì´ì–´ ID
        let gameCode; // ê²Œì„ ì½”ë“œ
        let isHost = false; // í˜¸ìŠ¤íŠ¸ ì—¬ë¶€
        let playerReady = false; // í”Œë ˆì´ì–´ ì¤€ë¹„ ìƒíƒœ
        let opponentReady = false; // ìƒëŒ€ë°© ì¤€ë¹„ ìƒíƒœ
        let gameStarted = false; // ê²Œì„ ì‹œì‘ ì—¬ë¶€
        let isMyTurn = false; // í˜„ì¬ ì°¨ë¡€
        let playerDeck = []; // í”Œë ˆì´ì–´ ë±
        let opponentDeck = []; // ìƒëŒ€ë°© ë±
        let playerActiveCard = null; // í”Œë ˆì´ì–´ í™œì„± ì¹´ë“œ
        let opponentActiveCard = null; // ìƒëŒ€ë°© í™œì„± ì¹´ë“œ
        let ringTimeout = null; // ì¢… ì• ë‹ˆë©”ì´ì…˜ íƒ€ì„ì•„ì›ƒ
        let connectedToPeer = false; // í”¼ì–´ ì—°ê²° ìƒíƒœ
        let gameMode = 'online'; // ê²Œì„ ëª¨ë“œ (online, ai, localMulti)
        let countdownInterval = null; // ì¹´ìš´íŠ¸ë‹¤ìš´ ì¸í„°ë²Œ
        let aiTurnTimeout = null; // AI í„´ íƒ€ì´ë¨¸
        let currentPlayer = 1; // ë¡œì»¬ ë©€í‹°í”Œë ˆì´ì–´ìš© í˜„ì¬ í”Œë ˆì´ì–´ (1 ë˜ëŠ” 2)
        
        // PeerJS ì„¤ì •
        const peerConfig = {
            debug: 0 // ë””ë²„ê·¸ ë©”ì‹œì§€ ì•ˆë³´ì´ê²Œ ì„¤ì •
        };

        // ê³¼ì¼ ì´ëª¨ì§€ ë°°ì—´
        const fruits = ['ğŸ', 'ğŸŒ', 'ğŸ‡', 'ğŸ“', 'ğŸ', 'ğŸŠ', 'ğŸ‘', 'ğŸˆ', 'ğŸ‰', 'ğŸ¥'];

        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const connectionScreen = document.querySelector('.connection-screen');
        const waitingScreen = document.querySelector('.waiting-screen');
        const gameplayScreen = document.querySelector('.gameplay-screen');
        const createBtn = document.getElementById('create-btn');
        const joinBtn = document.getElementById('join-btn');
        const joinId = document.getElementById('join-id');
        const peerIdContainer = document.getElementById('peer-id-container');
        const peerIdDisplay = document.getElementById('peer-id');
        const connectionStatus = document.getElementById('connection-status');
        const readyBtn = document.getElementById('ready-btn');
        const backBtn = document.getElementById('back-btn');
        const myReadyStatus = document.getElementById('my-ready');
        const opponentReadyStatus = document.getElementById('opponent-ready');
        const playerCardsCount = document.getElementById('player-cards');
        const opponentCardsCount = document.getElementById('opponent-cards');
        const playerDeckCount = document.getElementById('player-deck-count');
        const opponentDeckCount = document.getElementById('opponent-deck-count');
        const playerActiveCardContainer = document.querySelector('.player-active-card');
        const opponentActiveCardContainer = document.querySelector('.opponent-active-card');
        const player1Name = document.getElementById('player1-name');
        const player2Name = document.getElementById('player2-name');
        const bell = document.getElementById('bell');
        const countdown = document.querySelector('.countdown');
        const gameMessage = document.querySelector('.game-message');
        const playerTurnIndicator = document.querySelector('.player-turn');
        const opponentTurnIndicator = document.querySelector('.opponent-turn');
        const chatToggle = document.getElementById('chat-toggle');
        const chatContainer = document.querySelector('.chat-container');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat');
        const loader = document.getElementById('loader');
        const localPlayBtn = document.getElementById('local-play-btn');
        const localMultiBtn = document.getElementById('local-multi-btn');
        const controlsList = document.getElementById('controls-list');
        const controlsDesc = document.getElementById('controls-desc');

        // ì˜¤ë¥˜ ì²˜ë¦¬ì™€ ë¡œê·¸ ê°œì„ 
        function logError(message, error) {
            console.error(message, error);
            
            // ì‹¬ê°í•œ ì˜¤ë¥˜ ì‹œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
            if (message.includes('ì—°ê²°') || message.includes('ì˜¤ë¥˜')) {
                showErrorMessage(message);
            }
        }
        
        // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showErrorMessage(message) {
            // ê¸°ì¡´ ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê±°
            const existingError = connectionStatus.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            connectionStatus.appendChild(errorDiv);
        }

        // 3ìë¦¬ ê²Œì„ ì½”ë“œ ìƒì„± í•¨ìˆ˜
        function generateGameCode() {
            // 100ë¶€í„° 999ê¹Œì§€ì˜ ëœë¤ ìˆ«ì (3ìë¦¬)
            return Math.floor(Math.random() * 900 + 100).toString();
        }

        // ë¡œì»¬ AI ê²Œì„ ì‹œì‘ í•¨ìˆ˜
        function startAIGame() {
            gameMode = 'ai';
            isHost = true; // í”Œë ˆì´ì–´ê°€ í•­ìƒ í˜¸ìŠ¤íŠ¸
            
            // ëŒ€ê¸° í™”ë©´ìœ¼ë¡œ ì „í™˜
            showScreen(waitingScreen);
            
            // ëŒ€ê¸° í™”ë©´ í…ìŠ¤íŠ¸ ë³€ê²½
            document.querySelector('.waiting-screen h2').textContent = 'ğŸ¤– AI ëª¨ë“œ ğŸ¤–';
            document.querySelector('.ready-status p:nth-child(2)').innerHTML = 
                'ì»´í“¨í„°: <span id="opponent-ready" class="yes">ì¤€ë¹„ ì™„ë£Œ âœ…</span>';
            
            // ìƒëŒ€ë°©(ì»´í“¨í„°)ì€ ì´ë¯¸ ì¤€ë¹„ ì™„ë£Œ
            opponentReady = true;
            opponentReadyStatus = document.getElementById('opponent-ready');
            opponentReadyStatus.textContent = 'ì¤€ë¹„ ì™„ë£Œ âœ…';
            opponentReadyStatus.className = 'yes';
            
            // ì¡°ì‘ë²• ì—…ë°ì´íŠ¸
            updateControlsForGameMode();
        }
        
        // ë¡œì»¬ ë©€í‹°í”Œë ˆì´ì–´ ê²Œì„ ì‹œì‘ í•¨ìˆ˜
        function startLocalMultiGame() {
            gameMode = 'localMulti';
            isHost = true; // ì˜ë¯¸ ì—†ìŒ
            
            // ëŒ€ê¸° í™”ë©´ìœ¼ë¡œ ì „í™˜
            showScreen(waitingScreen);
            
            // ëŒ€ê¸° í™”ë©´ í…ìŠ¤íŠ¸ ë³€ê²½
            document.querySelector('.waiting-screen h2').textContent = 'ğŸ‘¥ ë¡œì»¬ 2ì¸ í”Œë ˆì´ ğŸ‘¥';
            document.querySelector('.ready-status p:nth-child(1)').innerHTML = 
                'í”Œë ˆì´ì–´ 1: <span id="my-ready" class="no">ì¤€ë¹„ ì•ˆë¨ âŒ</span>';
            document.querySelector('.ready-status p:nth-child(2)').innerHTML = 
                'í”Œë ˆì´ì–´ 2: <span id="opponent-ready" class="no">ì¤€ë¹„ ì•ˆë¨ âŒ</span>';
            
            // ì¤€ë¹„ ìƒíƒœ ì´ˆê¸°í™”
            playerReady = false;
            opponentReady = false;
            myReadyStatus = document.getElementById('my-ready');
            opponentReadyStatus = document.getElementById('opponent-ready');
            
            // ì¤€ë¹„ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
            readyBtn.textContent = 'âœ… ëª¨ë‘ ì¤€ë¹„ ì™„ë£Œ';
            
            // í”Œë ˆì´ì–´ ì´ë¦„ ë³€ê²½
            player1Name.textContent = 'ğŸŸ¢ í”Œë ˆì´ì–´ 1';
            player2Name.textContent = 'ğŸ”µ í”Œë ˆì´ì–´ 2';
            
            // ì¡°ì‘ë²• ì—…ë°ì´íŠ¸
            updateControlsForGameMode();
        }
        
        // ê²Œì„ ëª¨ë“œì— ë”°ë¥¸ ì¡°ì‘ë²• ì—…ë°ì´íŠ¸
        function updateControlsForGameMode() {
            controlsList.innerHTML = '';
            
            if (gameMode === 'localMulti') {
                // ë¡œì»¬ ë©€í‹°í”Œë ˆì´ì–´ ì¡°ì‘ë²•
                controlsList.innerHTML = `
                    <li><span class="key">W</span> í”Œë ˆì´ì–´ 1: ì¹´ë“œ ë‚´ê¸°</li>
                    <li><span class="key">Space</span> í”Œë ˆì´ì–´ 1: ì¢… ì¹˜ê¸°</li>
                    <li><span class="key">â†‘</span> í”Œë ˆì´ì–´ 2: ì¹´ë“œ ë‚´ê¸°</li>
                    <li><span class="key">Enter</span> í”Œë ˆì´ì–´ 2: ì¢… ì¹˜ê¸°</li>
                `;
                controlsDesc.innerHTML = `
                    <strong>ğŸŸ¢ í”Œë ˆì´ì–´ 1:</strong> Wí‚¤ë¡œ ì¹´ë“œ ë‚´ê¸°, ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ ì¢… ì¹˜ê¸°<br>
                    <strong>ğŸ”µ í”Œë ˆì´ì–´ 2:</strong> ìœ„ìª½ í™”ì‚´í‘œë¡œ ì¹´ë“œ ë‚´ê¸°, ì—”í„°í‚¤ë¡œ ì¢… ì¹˜ê¸°<br>
                    ğŸ”” ê°™ì€ ê³¼ì¼ì´ ì •í™•íˆ 5ê°œ ìˆì„ ë•Œ ì¢…ì„ ì³ì•¼ í•©ë‹ˆë‹¤!
                `;
            } else if (gameMode === 'ai') {
                // AI ê²Œì„ ì¡°ì‘ë²•
                controlsList.innerHTML = `
                    <li><span class="key">â†‘</span> ì¹´ë“œ ë‚´ê¸°</li>
                    <li><span class="key">Space</span> ì¢… ì¹˜ê¸°</li>
                `;
                controlsDesc.innerHTML = `
                    ğŸ”” ê°™ì€ ê³¼ì¼ì´ ì •í™•íˆ 5ê°œ ìˆì„ ë•Œ ì¢…ì„ ì³ì•¼ í•©ë‹ˆë‹¤!<br>
                    âš ï¸ ì˜ëª» ì¢…ì„ ì¹˜ë©´ ìƒëŒ€ë°©ì—ê²Œ ì¹´ë“œ 2ì¥ì„ ì¤˜ì•¼ í•©ë‹ˆë‹¤.
                `;
            } else {
                // ì˜¨ë¼ì¸ ê²Œì„ ì¡°ì‘ë²•
                controlsList.innerHTML = `
                    <li><span class="key">â†‘</span> ì¹´ë“œ ë‚´ê¸°</li>
                    <li><span class="key">Space</span> ì¢… ì¹˜ê¸°</li>
                `;
                controlsDesc.innerHTML = `
                    ğŸ”” ê°™ì€ ê³¼ì¼ì´ ì •í™•íˆ 5ê°œ ìˆì„ ë•Œ ì¢…ì„ ì³ì•¼ í•©ë‹ˆë‹¤!<br>
                    âš ï¸ ì˜ëª» ì¢…ì„ ì¹˜ë©´ ìƒëŒ€ë°©ì—ê²Œ ì¹´ë“œ 2ì¥ì„ ì¤˜ì•¼ í•©ë‹ˆë‹¤.
                `;
            }
        }

        // ê²Œì„ ì´ˆê¸°í™” í•¨ìˆ˜
        function initGame() {
            // ì¹´ë“œ ë± ìƒì„±
            createDecks();
            
            // ì¹´ë“œ ìˆ˜ ì—…ë°ì´íŠ¸
            updateCardCounts();
            
            // í„´ í‘œì‹œê¸° ì—…ë°ì´íŠ¸
            updateTurnIndicator();
            
            // ê²Œì„ í™”ë©´ìœ¼ë¡œ ì „í™˜
            showScreen(gameplayScreen);
        }

        // ì¹´ë“œ ë± ìƒì„± í•¨ìˆ˜
        function createDecks() {
            console.log("ë± ìƒì„± ì‹œì‘");
            // ì´ˆê¸° ì¹´ë“œ ìƒì„± (ì´ 50ì¥)
            const allCards = [];
            
            // ê° ê³¼ì¼ íƒ€ì…ë³„ë¡œ ì¹´ë“œ ìƒì„±
            // 5ê°€ì§€ ê³¼ì¼, ê° 1~5ê°œì”©, ê° 2ì¥ì”© = ì´ 50ì¥
            const usedFruits = fruits.slice(0, 5); // ì²˜ìŒ 5ê°œì˜ ê³¼ì¼ë§Œ ì‚¬ìš©
            
            usedFruits.forEach(fruit => {
                for (let count = 1; count <= 5; count++) {
                    // ê° ìˆ«ìë‹¹ 2ì¥ì”© (1ê°œì§œë¦¬ ì¹´ë“œ 2ì¥, 2ê°œì§œë¦¬ ì¹´ë“œ 2ì¥, ...)
                    allCards.push({ fruit, count });
                    allCards.push({ fruit, count });
                }
            });
            
            console.log(`ìƒì„±ëœ ì „ì²´ ì¹´ë“œ: ${allCards.length}ì¥`);
            
            // ì¹´ë“œ ì„ê¸°
            shuffleArray(allCards);
            
            // ì¹´ë“œ ë¶„ë°°
            if (gameMode === 'ai' || gameMode === 'localMulti') {
                // ë¡œì»¬ ê²Œì„ì—ì„œëŠ” ì§ì ‘ ë¶„ë°°
                playerDeck = allCards.slice(0, 25);
                opponentDeck = allCards.slice(25, 50);
                console.log(`ë¡œì»¬ ê²Œì„ ì¹´ë“œ ë¶„ë°°: í”Œë ˆì´ì–´ ${playerDeck.length}ì¥, ìƒëŒ€ë°© ${opponentDeck.length}ì¥`);
            } else if (isHost) {
                // ì˜¨ë¼ì¸ í”Œë ˆì´ì—ì„œ í˜¸ìŠ¤íŠ¸ê°€ ë¶„ë°°
                playerDeck = allCards.slice(0, 25);
                opponentDeck = allCards.slice(25, 50);
                console.log(`ì˜¨ë¼ì¸ ê²Œì„(í˜¸ìŠ¤íŠ¸) ì¹´ë“œ ë¶„ë°°: í”Œë ˆì´ì–´ ${playerDeck.length}ì¥, ìƒëŒ€ë°© ${opponentDeck.length}ì¥`);
                
                // ìƒëŒ€ë°©ì—ê²Œ ë± ì •ë³´ ì „ì†¡
                if (conn && conn.open) {
                    sendGameData('init-decks', {
                        playerDeck: opponentDeck,
                        opponentDeck: playerDeck
                    });
                }
            }
            
            // ë± ì •ë³´ ì½˜ì†”ì— ì¶œë ¥
            console.log("í”Œë ˆì´ì–´ ë± ì²« 5ì¥:", playerDeck.slice(0, 5));
            console.log("ìƒëŒ€ë°© ë± ì²« 5ì¥:", opponentDeck.slice(0, 5));
        }

        // ë°°ì—´ ì„ê¸° í•¨ìˆ˜ (Fisher-Yates ì•Œê³ ë¦¬ì¦˜)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // ì¹´ë“œ ìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateCardCounts() {
            playerCardsCount.textContent = playerDeck.length;
            opponentCardsCount.textContent = opponentDeck.length;
            playerDeckCount.textContent = playerDeck.length;
            opponentDeckCount.textContent = opponentDeck.length;
            
            // ë±ì´ ë¹„ì—ˆëŠ”ì§€ í™•ì¸
            if (playerDeck.length === 0) {
                gameOver(false); // íŒ¨ë°°
            } else if (opponentDeck.length === 0) {
                gameOver(true); // ìŠ¹ë¦¬
            } else if (playerDeck.length >= 50) {
                // ëª¨ë“  ì¹´ë“œë¥¼ íšë“í•œ ê²½ìš°
                gameOver(true);
            } else if (opponentDeck.length >= 50) {
                // ìƒëŒ€ë°©ì´ ëª¨ë“  ì¹´ë“œë¥¼ íšë“í•œ ê²½ìš°
                gameOver(false);
            }
        }

        // í„´ í‘œì‹œê¸° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateTurnIndicator() {
            if (gameMode === 'localMulti') {
                // ë¡œì»¬ ë©€í‹°í”Œë ˆì´ì–´ì—ì„œëŠ” í˜„ì¬ í”Œë ˆì´ì–´ í‘œì‹œ
                playerTurnIndicator.textContent = 
                    currentPlayer === 2 ? 'ğŸ‘‰ í”Œë ˆì´ì–´ 2 ì°¨ë¡€ì…ë‹ˆë‹¤!' : 'ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...';
                opponentTurnIndicator.textContent = 
                    currentPlayer === 1 ? 'ğŸ‘‰ í”Œë ˆì´ì–´ 1 ì°¨ë¡€ì…ë‹ˆë‹¤!' : 'ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...';
                
                playerTurnIndicator.classList.toggle('active', currentPlayer === 2);
                opponentTurnIndicator.classList.toggle('active', currentPlayer === 1);
            } else {
                // ì˜¨ë¼ì¸ ë˜ëŠ” AI ê²Œì„ì—ì„œëŠ” ë‚´ í„´ í‘œì‹œ
                playerTurnIndicator.classList.toggle('active', isMyTurn);
                opponentTurnIndicator.classList.toggle('active', !isMyTurn);
            }
        }

        // í™”ë©´ ì „í™˜ í•¨ìˆ˜
        function showScreen(screen) {
            connectionScreen.classList.remove('screen-active');
            waitingScreen.classList.remove('screen-active');
            gameplayScreen.classList.remove('screen-active');
            
            screen.classList.add('screen-active');
        }

        // ë¡œë”© í‘œì‹œ/ìˆ¨ê¹€ í•¨ìˆ˜
        function toggleLoader(show) {
            if (show) {
                loader.classList.add('active');
            } else {
                loader.classList.remove('active');
            }
        }

        // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showMessage(msg, duration = 3000) {
            gameMessage.textContent = msg;
            gameMessage.classList.add('show');
            
            setTimeout(() => {
                gameMessage.classList.remove('show');
            }, duration);
        }

        // ì¹´ìš´íŠ¸ë‹¤ìš´ í‘œì‹œ í•¨ìˆ˜
        function showCountdown(count) {
            countdown.textContent = count;
            countdown.classList.add('show');
            
            setTimeout(() => {
                countdown.classList.remove('show');
            }, 900);
        }

        // ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘ í•¨ìˆ˜
        function startCountdown() {
            let count = 3;
            
            // ì´ì „ ì¹´ìš´íŠ¸ë‹¤ìš´ì´ ìˆë‹¤ë©´ ì •ë¦¬
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            countdownInterval = setInterval(() => {
                showCountdown(count);
                
                if (gameMode === 'online' && conn && conn.open) {
                    sendGameData('countdown', { count });
                }
                
                if (count === 0) {
                    clearInterval(countdownInterval);
                    startGame();
                }
                
                count--;
            }, 1000);
        }

        // ê²Œì„ ì‹œì‘ í•¨ìˆ˜
        function startGame() {
            console.log("ê²Œì„ ì‹œì‘");
            
            // ê²Œì„ ì‹œì‘ ì „ì— ì¹´ë“œ ë± í™•ì¸
            if (playerDeck.length === 0 || opponentDeck.length === 0) {
                console.log("ë±ì´ ë¹„ì–´ìˆì–´ ë‹¤ì‹œ ìƒì„±í•©ë‹ˆë‹¤.");
                // ë±ì´ ë¹„ì–´ìˆìœ¼ë©´ ë‹¤ì‹œ ìƒì„±
                createDecks();
            }
            
            console.log(`ê²Œì„ ì‹œì‘ ì‹œ ì¹´ë“œ ìˆ˜: í”Œë ˆì´ì–´ ${playerDeck.length}ì¥, ìƒëŒ€ë°© ${opponentDeck.length}ì¥`);
            
            gameStarted = true;
            
            if (gameMode === 'localMulti') {
                // ë¡œì»¬ ë©€í‹°í”Œë ˆì´ì–´ëŠ” í”Œë ˆì´ì–´ 1 ì„ ê³µ
                currentPlayer = 1;
            } else {
                // ì˜¨ë¼ì¸/AI ê²Œì„ì€ í˜¸ìŠ¤íŠ¸ ì„ ê³µ
                isMyTurn = isHost;
            }
            
            // í„´ í‘œì‹œê¸° ì—…ë°ì´íŠ¸
            updateTurnIndicator();
            
            // ê²Œì„ ì‹œì‘ ë©”ì‹œì§€
            showMessage('ğŸ® ê²Œì„ ì‹œì‘! ğŸ®');
            
            // ì´ˆê¸° ë± ì •ë³´ ì—…ë°ì´íŠ¸
            updateCardCounts();
            
            // ê²Œì„ í™”ë©´ìœ¼ë¡œ ì „í™˜
            showScreen(gameplayScreen);
            
            // AI ê²Œì„ì—ì„œ AI í„´ ì²˜ë¦¬
            if (gameMode === 'ai' && !isMyTurn) {
                scheduleAITurn();
            }
        }

        // AI í„´ ì˜ˆì•½ í•¨ìˆ˜
        function scheduleAITurn() {
            if (gameMode !== 'ai' || isMyTurn || !gameStarted) return;
            
            // AI í„´ì„ ìœ„í•œ íƒ€ì„ì•„ì›ƒ ì„¤ì •
            aiTurnTimeout = setTimeout(() => {
                playAITurn();
            }, Math.random() * 1500 + 1000); // 1~2.5ì´ˆ ëœë¤ ë”œë ˆì´
        }
        
        // AI í„´ ì‹¤í–‰ í•¨ìˆ˜
        function playAITurn() {
            if (!gameStarted || gameMode !== 'ai') return;
            
            // AI ì¹´ë“œ ë‚´ê¸°
            if (opponentDeck.length > 0) {
                opponentActiveCard = opponentDeck.shift();
                renderActiveCard(opponentActiveCard, opponentActiveCardContainer, true);
                updateCardCounts();
                
                // í„´ ë³€ê²½
                isMyTurn = true;
                updateTurnIndicator();
                
                // ì¹´ë“œê°€ 5ê°œì¸ì§€ í™•ì¸í•˜ê³  ì¼ì • í™•ë¥ ë¡œ ì¢…ì„ ì¹œë‹¤
                if (checkBellCondition()) {
                    // 70% í™•ë¥ ë¡œ AIê°€ ì •í™•í•˜ê²Œ ì¢…ì„ ì¹¨
                    if (Math.random() < 0.7) {
                        setTimeout(() => {
                            if (!gameStarted) return;
                            aiRingBell(true);
                        }, Math.random() * 800 + 500); // 0.5~1.3ì´ˆ ëœë¤ ë”œë ˆì´
                    }
                } else {
                    // 10% í™•ë¥ ë¡œ AIê°€ ì‹¤ìˆ˜ë¡œ ì¢…ì„ ì¹¨
                    if (Math.random() < 0.1) {
                        setTimeout(() => {
                            if (!gameStarted) return;
                            aiRingBell(false);
                        }, Math.random() * 1000 + 1000); // 1~2ì´ˆ ëœë¤ ë”œë ˆì´
                    }
                }
            }
        }

        // AI ì¢… ì¹˜ê¸° í•¨ìˆ˜
        function aiRingBell(isCorrect) {
            if (!gameStarted || gameMode !== 'ai') return;
            
            // ì¢… ì• ë‹ˆë©”ì´ì…˜
            bell.classList.add('ringing');
            
            if (ringTimeout) {
                clearTimeout(ringTimeout);
            }
            
            ringTimeout = setTimeout(() => {
                bell.classList.remove('ringing');
            }, 400);
            
            // ì¢… ì¹˜ê¸° ê²°ê³¼ ì²˜ë¦¬
            handleBellResult(isCorrect, false);
        }

        // ê²Œì„ ì¢…ë£Œ í•¨ìˆ˜
        function gameOver(isWinner) {
            // ì´ë¯¸ ê²Œì„ì´ ì¢…ë£Œëœ ìƒíƒœë¼ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
            if (!gameStarted) return;
            
            gameStarted = false;
            
            // AI í„´ íƒ€ì´ë¨¸ ì •ë¦¬
            if (aiTurnTimeout) {
                clearTimeout(aiTurnTimeout);
                aiTurnTimeout = null;
            }
            
            if (gameMode === 'localMulti') {
                // ë¡œì»¬ ë©€í‹°í”Œë ˆì´ì–´ ê²Œì„ ì¢…ë£Œ
                const winnerText = isWinner ? "ğŸŸ¢ í”Œë ˆì´ì–´ 1" : "ğŸ”µ í”Œë ˆì´ì–´ 2";
                showMessage(`ğŸ‰ ${winnerText} ìŠ¹ë¦¬! ğŸ‰`, 5000);
            } else {
                // ì˜¨ë¼ì¸/AI ê²Œì„ ì¢…ë£Œ
                if (isWinner) {
                    showMessage('ğŸ‰ ê²Œì„ ìŠ¹ë¦¬! ğŸ‰', 5000);
                } else {
                    showMessage('ğŸ˜¢ ê²Œì„ íŒ¨ë°°! ğŸ˜¢', 5000);
                }
            }
            
            // 3ì´ˆ í›„ ëŒ€ê¸° í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            setTimeout(() => {
                // ì¤€ë¹„ ìƒíƒœ ì´ˆê¸°í™”
                playerReady = false;
                opponentReady = false;
                
                if (gameMode === 'localMulti') {
                    // ë¡œì»¬ ë©€í‹°í”Œë ˆì´ì–´ ì¤€ë¹„ ìƒíƒœ ì´ˆê¸°í™”
                    myReadyStatus.textContent = 'ì¤€ë¹„ ì•ˆë¨ âŒ';
                    myReadyStatus.className = 'no';
                    opponentReadyStatus.textContent = 'ì¤€ë¹„ ì•ˆë¨ âŒ';
                    opponentReadyStatus.className = 'no';
                    readyBtn.textContent = 'âœ… ëª¨ë‘ ì¤€ë¹„ ì™„ë£Œ';
                } else if (gameMode === 'ai') {
                    // AI ê²Œì„ ì¤€ë¹„ ìƒíƒœ ì´ˆê¸°í™”
                    myReadyStatus.textContent = 'ì¤€ë¹„ ì•ˆë¨ âŒ';
                    myReadyStatus.className = 'no';
                    opponentReadyStatus.textContent = 'ì¤€ë¹„ ì™„ë£Œ âœ…';
                    opponentReadyStatus.className = 'yes';
                    readyBtn.textContent = 'âœ… ì¤€ë¹„ ì™„ë£Œ';
                } else {
                    // ì˜¨ë¼ì¸ ê²Œì„ ì¤€ë¹„ ìƒíƒœ ì´ˆê¸°í™”
                    myReadyStatus.textContent = 'ì¤€ë¹„ ì•ˆë¨ âŒ';
                    myReadyStatus.className = 'no';
                    opponentReadyStatus.textContent = 'ì¤€ë¹„ ì•ˆë¨ âŒ';
                    opponentReadyStatus.className = 'no';
                    readyBtn.textContent = 'âœ… ì¤€ë¹„ ì™„ë£Œ';
                }
                
                // í™œì„± ì¹´ë“œ ì œê±°
                playerActiveCardContainer.innerHTML = '';
                opponentActiveCardContainer.innerHTML = '';
                
                // ëŒ€ê¸° í™”ë©´ìœ¼ë¡œ ì „í™˜
                showScreen(waitingScreen);
                
                // ì˜¨ë¼ì¸ ëª¨ë“œì—ì„œë§Œ ìƒëŒ€ë°©ì—ê²Œ ê²Œì„ ì¢…ë£Œ ì•Œë¦¼
                if (gameMode === 'online' && conn && conn.open) {
                    sendGameData('game-over', { isWinner: !isWinner });
                }
            }, 5000);
        }

        // ì¹´ë“œ ë‚´ê¸° í•¨ìˆ˜ (í”Œë ˆì´ì–´)
        function playCard(playerNumber = 2) {
            if (!gameStarted) return;
            
            if (gameMode === 'localMulti') {
                // ë¡œì»¬ ë©€í‹°í”Œë ˆì´ì–´ ëª¨ë“œ
                if (currentPlayer !== playerNumber) return; // í˜„ì¬ í”Œë ˆì´ì–´ë§Œ ì¹´ë“œ ë‚¼ ìˆ˜ ìˆìŒ
                
                if (playerNumber === 1) {
                    // í”Œë ˆì´ì–´ 1 (ìœ„ìª½)
                    if (opponentDeck.length === 0) return;
                    
                    opponentActiveCard = opponentDeck.shift();
                    renderActiveCard(opponentActiveCard, opponentActiveCardContainer, true);
                } else {
                    // í”Œë ˆì´ì–´ 2 (ì•„ë˜ìª½)
                    if (playerDeck.length === 0) return;
                    
                    playerActiveCard = playerDeck.shift();
                    renderActiveCard(playerActiveCard, playerActiveCardContainer, false);
                }
                
                // í„´ ë³€ê²½
                currentPlayer = currentPlayer === 1 ? 2 : 1;
                updateTurnIndicator();
            } else {
                // ì˜¨ë¼ì¸/AI ëª¨ë“œ
                if (!isMyTurn || playerDeck.length === 0) return;
                
                // ì¹´ë“œ ê°€ì ¸ì˜¤ê¸°
                playerActiveCard = playerDeck.shift();
                
                // ì¹´ë“œ í‘œì‹œ
                renderActiveCard(playerActiveCard, playerActiveCardContainer, false);
                
                // ì˜¨ë¼ì¸ í”Œë ˆì´ì—ì„œë§Œ ìƒëŒ€ë°©ì—ê²Œ ì•Œë¦¼
                if (gameMode === 'online' && conn && conn.open) {
                    sendGameData('play-card', { card: playerActiveCard });
                }
                
                // í„´ ë³€ê²½
                isMyTurn = false;
                updateTurnIndicator();
                
                // AI ê²Œì„ì—ì„œ AI í„´ ì‹¤í–‰
                if (gameMode === 'ai') {
                    scheduleAITurn();
                }
            }
            
            // ì¹´ë“œ ìˆ˜ ì—…ë°ì´íŠ¸
            updateCardCounts();
        }

        // ìƒëŒ€ë°© ì¹´ë“œ ì²˜ë¦¬ í•¨ìˆ˜ (ì˜¨ë¼ì¸ ëª¨ë“œìš©)
        function handleOpponentPlayCard(card) {
            opponentActiveCard = card;
            
            // ì¹´ë“œ í‘œì‹œ
            renderActiveCard(opponentActiveCard, opponentActiveCardContainer, true);
            
            // ì¹´ë“œ ìˆ˜ ì—…ë°ì´íŠ¸
            opponentDeck.shift();
            updateCardCounts();
            
            // í„´ ë³€ê²½
            isMyTurn = true;
            updateTurnIndicator();
        }

        // í™œì„± ì¹´ë“œ ë Œë”ë§ í•¨ìˆ˜
        function renderActiveCard(card, container, isOpponent) {
            container.innerHTML = '';
            
            if (!card) return;
            
            const cardEl = document.createElement('div');
            cardEl.className = 'card';
            
            const cardContent = document.createElement('div');
            cardContent.className = 'card-front';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'card-content';
            
            // ì¹´ë“œì— ê³¼ì¼ ì´ëª¨ì§€ í‘œì‹œ
            for (let i = 0; i < card.count; i++) {
                const fruitSpan = document.createElement('span');
                fruitSpan.className = 'fruit-item';
                fruitSpan.textContent = card.fruit;
                contentDiv.appendChild(fruitSpan);
            }
            
            cardContent.appendChild(contentDiv);
            cardEl.appendChild(cardContent);
            container.appendChild(cardEl);
            
            // ì¹´ë“œ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜
            setTimeout(() => {
                cardEl.style.transform = isOpponent ? 
                    'translateY(20px)' : 'translateY(-20px)';
            }, 10);
        }

        // ì¢… ì¹˜ê¸° í•¨ìˆ˜
        function ringBell(playerNumber = 2) {
            if (!gameStarted) return;
            
            // ì¢… ì• ë‹ˆë©”ì´ì…˜
            bell.classList.add('ringing');
            
            if (ringTimeout) {
                clearTimeout(ringTimeout);
            }
            
            ringTimeout = setTimeout(() => {
                bell.classList.remove('ringing');
            }, 400);
            
            if (gameMode === 'localMulti') {
                // ë¡œì»¬ ë©€í‹°í”Œë ˆì´ì–´ ëª¨ë“œì—ì„œëŠ” ë‘ í”Œë ˆì´ì–´ ëª¨ë‘ ì–¸ì œë“ ì§€ ì¢…ì„ ì¹  ìˆ˜ ìˆìŒ
                const isValidRing = checkBellCondition(true);
                // ì¢…ì„ ì¹œ í”Œë ˆì´ì–´ê°€ ì´ê¸´ ê²ƒìœ¼ë¡œ ì²˜ë¦¬
                handleLocalMultiBellResult(isValidRing, playerNumber);
            } else {
                // ì˜¨ë¼ì¸/AI ëª¨ë“œ
                const isValidRing = checkBellCondition(true);
                
                // ì˜¨ë¼ì¸ ëª¨ë“œì—ì„œë§Œ ìƒëŒ€ë°©ì—ê²Œ ì•Œë¦¼
                if (gameMode === 'online' && conn && conn.open) {
                    sendGameData('ring-bell', { isValid: isValidRing });
                }
                
                // ì¢… ì¹˜ê¸° ê²°ê³¼ ì²˜ë¦¬
                handleBellResult(isValidRing, true);
            }
        }

        // ë¡œì»¬ ë©€í‹°í”Œë ˆì´ì–´ ì¢… ì¹˜ê¸° ê²°ê³¼ ì²˜ë¦¬ í•¨ìˆ˜
        function handleLocalMultiBellResult(isValid, playerNumber) {
            if (isValid) {
                // ì¢…ì„ ì˜¬ë°”ë¥´ê²Œ ì¹œ ê²½ìš°
                if (playerNumber === 1) {
                    // í”Œë ˆì´ì–´ 1ì´ ì¢…ì„ ì¹œ ê²½ìš°
                    // ë‘ í”Œë ˆì´ì–´ì˜ í™œì„± ì¹´ë“œë¥¼ ëª¨ë‘ í”Œë ˆì´ì–´ 1ì˜ ë±ìœ¼ë¡œ ì´ë™
                    if (playerActiveCard) {
                        opponentDeck.push(playerActiveCard);
                    }
                    if (opponentActiveCard) {
                        opponentDeck.push(opponentActiveCard);
                    }
                    showMessage('ğŸ¯ í”Œë ˆì´ì–´ 1 ì„±ê³µ! ì¹´ë“œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.', 2000);
                } else {
                    // í”Œë ˆì´ì–´ 2ê°€ ì¢…ì„ ì¹œ ê²½ìš°
                    // ë‘ í”Œë ˆì´ì–´ì˜ í™œì„± ì¹´ë“œë¥¼ ëª¨ë‘ í”Œë ˆì´ì–´ 2ì˜ ë±ìœ¼ë¡œ ì´ë™
                    if (playerActiveCard) {
                        playerDeck.push(playerActiveCard);
                    }
                    if (opponentActiveCard) {
                        playerDeck.push(opponentActiveCard);
                    }
                    showMessage('ğŸ¯ í”Œë ˆì´ì–´ 2 ì„±ê³µ! ì¹´ë“œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.', 2000);
                }
            } else {
                // ì¢…ì„ ì˜ëª» ì¹œ ê²½ìš° - ìƒëŒ€ë°©ì—ê²Œ ì¹´ë“œ 2ì¥ ì£¼ê¸°
                if (playerNumber === 1) {
                    // í”Œë ˆì´ì–´ 1ì´ ì¢…ì„ ì˜ëª» ì¹œ ê²½ìš°
                    if (opponentDeck.length >= 2) {
                        const penaltyCards = opponentDeck.splice(0, 2);
                        playerDeck.push(...penaltyCards);
                        showMessage('âŒ í”Œë ˆì´ì–´ 1 ì˜¤ë¥˜! ì¹´ë“œ 2ì¥ì„ í”Œë ˆì´ì–´ 2ì—ê²Œ ì¤¬ìŠµë‹ˆë‹¤.', 2000);
                    } else if (opponentDeck.length === 1) {
                        const penaltyCard = opponentDeck.shift();
                        playerDeck.push(penaltyCard);
                        showMessage('âŒ í”Œë ˆì´ì–´ 1 ì˜¤ë¥˜! ì¹´ë“œ 1ì¥ì„ í”Œë ˆì´ì–´ 2ì—ê²Œ ì¤¬ìŠµë‹ˆë‹¤.', 2000);
                    }
                } else {
                    // í”Œë ˆì´ì–´ 2ê°€ ì¢…ì„ ì˜ëª» ì¹œ ê²½ìš°
                    if (playerDeck.length >= 2) {
                        const penaltyCards = playerDeck.splice(0, 2);
                        opponentDeck.push(...penaltyCards);
                        showMessage('âŒ í”Œë ˆì´ì–´ 2 ì˜¤ë¥˜! ì¹´ë“œ 2ì¥ì„ í”Œë ˆì´ì–´ 1ì—ê²Œ ì¤¬ìŠµë‹ˆë‹¤.', 2000);
                    } else if (playerDeck.length === 1) {
                        const penaltyCard = playerDeck.shift();
                        opponentDeck.push(penaltyCard);
                        showMessage('âŒ í”Œë ˆì´ì–´ 2 ì˜¤ë¥˜! ì¹´ë“œ 1ì¥ì„ í”Œë ˆì´ì–´ 1ì—ê²Œ ì¤¬ìŠµë‹ˆë‹¤.', 2000);
                    }
                }
            }
            
            // í™œì„± ì¹´ë“œ ì´ˆê¸°í™”
            playerActiveCard = null;
            opponentActiveCard = null;
            
            // í™œì„± ì¹´ë“œ í™”ë©´ ì´ˆê¸°í™”
            playerActiveCardContainer.innerHTML = '';
            opponentActiveCardContainer.innerHTML = '';
            
            // ì¹´ë“œ ìˆ˜ ì—…ë°ì´íŠ¸
            updateCardCounts();
            
            // í„´ ì¬ì„¤ì • (í•­ìƒ í”Œë ˆì´ì–´ 1ë¶€í„° ì‹œì‘)
            currentPlayer = 1;
            updateTurnIndicator();
        }

        // ìƒëŒ€ë°© ì¢… ì¹˜ê¸° ì²˜ë¦¬ í•¨ìˆ˜
        function handleOpponentRingBell(isValid) {
            // ì¢… ì• ë‹ˆë©”ì´ì…˜
            bell.classList.add('ringing');
            
            if (ringTimeout) {
                clearTimeout(ringTimeout);
            }
            
            ringTimeout = setTimeout(() => {
                bell.classList.remove('ringing');
            }, 400);
            
            // ì¢… ì¹˜ê¸° ê²°ê³¼ ì²˜ë¦¬
            handleBellResult(isValid, false);
        }

        // ì¢… ì¹˜ê¸° ê²°ê³¼ ì²˜ë¦¬ í•¨ìˆ˜ (ì˜¨ë¼ì¸/AI ëª¨ë“œìš©)
        function handleBellResult(isValid, isPlayer) {
            if (isValid) {
                // ì¢…ì„ ì˜¬ë°”ë¥´ê²Œ ì¹œ ê²½ìš°
                if (isPlayer) {
                    // í”Œë ˆì´ì–´ê°€ ì¢…ì„ ì¹œ ê²½ìš°
                    // ìƒëŒ€ë°©ì˜ í™œì„± ì¹´ë“œ ê°€ì ¸ì˜¤ê¸°
                    if (opponentActiveCard) {
                        playerDeck.push(opponentActiveCard);
                    }
                    
                    // í”Œë ˆì´ì–´ì˜ í™œì„± ì¹´ë“œ ê°€ì ¸ì˜¤ê¸°
                    if (playerActiveCard) {
                        playerDeck.push(playerActiveCard);
                    }
                    
                    showMessage('ğŸ¯ ì„±ê³µ! ì¹´ë“œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.', 2000);
                } else {
                    // ìƒëŒ€ë°©ì´ ì¢…ì„ ì¹œ ê²½ìš°
                    // ìƒëŒ€ë°©ì´ ëª¨ë“  í™œì„± ì¹´ë“œ ê°€ì ¸ê°
                    if (playerActiveCard) {
                        opponentDeck.push(playerActiveCard);
                    }
                    
                    if (opponentActiveCard) {
                        opponentDeck.push(opponentActiveCard);
                    }
                    
                    showMessage('ğŸ‘€ ìƒëŒ€ë°©ì´ ì¢…ì„ ì³ì„œ ì¹´ë“œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.', 2000);
                }
            } else {
                // ì¢…ì„ ì˜ëª» ì¹œ ê²½ìš°
                if (isPlayer) {
                    // í”Œë ˆì´ì–´ê°€ ì¢…ì„ ì˜ëª» ì¹œ ê²½ìš°
                    // íŒ¨ë„í‹°: ìƒëŒ€ë°©ì—ê²Œ ì¹´ë“œ 2ì¥ ì£¼ê¸°
                    if (playerDeck.length >= 2) {
                        const penaltyCards = playerDeck.splice(0, 2);
                        opponentDeck.push(...penaltyCards);
                        showMessage('âŒ ì˜ëª»ëœ ì¢…ì¹˜ê¸°! ì¹´ë“œ 2ì¥ì„ ìƒëŒ€ë°©ì—ê²Œ ì¤¬ìŠµë‹ˆë‹¤.', 2000);
                    } else if (playerDeck.length === 1) {
                        const penaltyCard = playerDeck.shift();
                        opponentDeck.push(penaltyCard);
                        showMessage('âŒ ì˜ëª»ëœ ì¢…ì¹˜ê¸°! ë§ˆì§€ë§‰ ì¹´ë“œë¥¼ ìƒëŒ€ë°©ì—ê²Œ ì¤¬ìŠµë‹ˆë‹¤.', 2000);
                    }
                } else {
                    // ìƒëŒ€ë°©ì´ ì¢…ì„ ì˜ëª» ì¹œ ê²½ìš°
                    if (opponentDeck.length >= 2) {
                        const penaltyCards = opponentDeck.splice(0, 2);
                        playerDeck.push(...penaltyCards);
                        showMessage('âœ… ìƒëŒ€ë°©ì´ ì˜ëª» ì¢…ì„ ì³¤ìŠµë‹ˆë‹¤! ì¹´ë“œ 2ì¥ì„ ë°›ì•˜ìŠµë‹ˆë‹¤.', 2000);
                    } else if (opponentDeck.length === 1) {
                        const penaltyCard = opponentDeck.shift();
                        playerDeck.push(penaltyCard);
                        showMessage('âœ… ìƒëŒ€ë°©ì´ ì˜ëª» ì¢…ì„ ì³¤ìŠµë‹ˆë‹¤! ë§ˆì§€ë§‰ ì¹´ë“œë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.', 2000);
                    }
                }
            }
            
            // í™œì„± ì¹´ë“œ ì´ˆê¸°í™”
            playerActiveCard = null;
            opponentActiveCard = null;
            
            // í™œì„± ì¹´ë“œ í™”ë©´ ì´ˆê¸°í™”
            playerActiveCardContainer.innerHTML = '';
            opponentActiveCardContainer.innerHTML = '';
            
            // ì¹´ë“œ ìˆ˜ ì—…ë°ì´íŠ¸
            updateCardCounts();
            
            // í„´ ì¬ì„¤ì • (í˜¸ìŠ¤íŠ¸ ì„ ê³µ)
            isMyTurn = isHost;
            updateTurnIndicator();
            
            // AI ê²Œì„ì—ì„œ AI í„´ ì²˜ë¦¬
            if (gameMode === 'ai' && !isMyTurn && gameStarted) {
                scheduleAITurn();
            }
        }

        // ì¢… ì¹  ìˆ˜ ìˆëŠ” ì¡°ê±´ í™•ì¸ í•¨ìˆ˜
        function checkBellCondition(isCheck = false) {
            // í”Œë ˆì´ì–´ì™€ ìƒëŒ€ë°©ì˜ í™œì„± ì¹´ë“œê°€ ëª¨ë‘ ìˆì–´ì•¼ í•¨
            if (!playerActiveCard || !opponentActiveCard) {
                return false;
            }
            
            // ê³¼ì¼ ê°œìˆ˜ ê³„ì‚°
            const fruitCounts = {};
            fruits.forEach(fruit => fruitCounts[fruit] = 0);
            
            // í”Œë ˆì´ì–´ ì¹´ë“œì˜ ê³¼ì¼ ê°œìˆ˜ ë”í•˜ê¸°
            fruitCounts[playerActiveCard.fruit] += playerActiveCard.count;
            
            // ìƒëŒ€ë°© ì¹´ë“œì˜ ê³¼ì¼ ê°œìˆ˜ ë”í•˜ê¸°
            fruitCounts[opponentActiveCard.fruit] += opponentActiveCard.count;
            
            // ì •í™•íˆ 5ê°œì¸ ê³¼ì¼ì´ ìˆëŠ”ì§€ í™•ì¸
            for (const fruit in fruitCounts) {
                if (fruitCounts[fruit] === 5) {
                    return true;
                }
            }
            
            return false;
        }
        
        // PeerJS ì´ˆê¸°í™” í•¨ìˆ˜
        function initPeerConnection() {
            console.log("PeerJS ì´ˆê¸°í™” ì‹œì‘");
            toggleLoader(true);
            connectedToPeer = false;
            gameMode = 'online';
            
            // ê¸°ì¡´ í”¼ì–´ ì—°ê²° ì™„ì „íˆ ì •ë¦¬
            if (peer) {
                try {
                    peer.destroy();
                    peer = null;
                    console.log("ê¸°ì¡´ í”¼ì–´ ì—°ê²° ì •ë¦¬ë¨");
                } catch (err) {
                    console.error("í”¼ì–´ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:", err);
                }
            }
            
            // ì—°ê²° ì •ë¦¬ë¥¼ ìœ„í•œ ì§€ì—°
            setTimeout(() => {
                connectionStatus.textContent = 'ğŸ”„ ê²Œì„ ì„œë²„ì— ì—°ê²° ì¤‘...';
                
                try {
                    // ê³ ìœ í•œ ID ìƒì„±
                    const uniqueId = isHost ? 
                        'jorigalli-host-' + gameCode : 
                        'jorigalli-guest-' + Date.now().toString(36);
                    
                    console.log(`ìƒˆ í”¼ì–´ IDë¡œ ì—°ê²° ì‹œë„: ${uniqueId}`);
                    
                    // ì•ˆì •ì ì¸ ì„¤ì •ìœ¼ë¡œ í”¼ì–´ ìƒì„±
                    peer = new Peer(uniqueId, {
                        debug: 1, // ìµœì†Œí•œì˜ ë””ë²„ê·¸ ë©”ì‹œì§€ë§Œ ë³´ì´ê²Œ
                        config: {
                            'iceServers': [
                                { urls: 'stun:stun.l.google.com:19302' },
                                { urls: 'stun:stun1.l.google.com:19302' },
                                { urls: 'stun:stun2.l.google.com:19302' },
                                { urls: 'stun:stun3.l.google.com:19302' },
                                { urls: 'stun:stun4.l.google.com:19302' }
                            ]
                        }
                    });
                    
                    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                    setupPeerEventListeners();
                    
                    // 15ì´ˆ í›„ì—ë„ ì—°ê²°ì´ ì•ˆë˜ë©´ ì¬ì‹œë„ ì˜µì…˜ ì œê³µ
                    setTimeout(() => {
                        if (!connectedToPeer) {
                            toggleLoader(false);
                            connectionStatus.innerHTML = 'âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨. <span style="text-decoration: underline; cursor: pointer; color: #FF6B6B;" id="retry-connection">ë‹¤ì‹œ ì‹œë„</span>í•˜ê±°ë‚˜ ì˜¤í”„ë¼ì¸ ëª¨ë“œë¥¼ ì´ìš©í•´ë³´ì„¸ìš”.';
                            
                            document.getElementById('retry-connection').addEventListener('click', () => {
                                if (isHost) {
                                    createBtn.click();
                                } else {
                                    joinBtn.click();
                                }
                            });
                            
                            // ë¡œì»¬ í”Œë ˆì´ ë²„íŠ¼ ê°•ì¡°
                            localMultiBtn.style.transform = 'scale(1.05)';
                            setTimeout(() => {
                                localMultiBtn.style.transform = '';
                            }, 2000);
                        }
                    }, 15000);
                } catch (error) {
                    console.error('í”¼ì–´ ìƒì„± ì˜¤ë¥˜:', error);
                    toggleLoader(false);
                    connectionStatus.innerHTML = 'âŒ ì—°ê²° ì˜¤ë¥˜. <span style="text-decoration: underline; cursor: pointer; color: #FF6B6B;" id="retry-connection">ë‹¤ì‹œ ì‹œë„</span>í•´ì£¼ì„¸ìš”.';
                    
                    document.getElementById('retry-connection').addEventListener('click', () => {
                        if (isHost) {
                            createBtn.click();
                        } else {
                            joinBtn.click();
                        }
                    });
                }
            }, 1000); // ê¸°ì¡´ ì—°ê²° ì •ë¦¬ë¥¼ ìœ„í•œ ì¶©ë¶„í•œ ì§€ì—°
        }

        // í”¼ì–´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • í•¨ìˆ˜
        function setupPeerEventListeners() {
            if (!peer) return;
            
            // ì—°ê²° ì„±ê³µ ì‹œ
            peer.on('open', id => {
                playerId = id;
                connectedToPeer = true;
                
                if (isHost) {
                    // í˜¸ìŠ¤íŠ¸ëŠ” ê²Œì„ ì½”ë“œ í‘œì‹œ
                    peerIdDisplay.textContent = gameCode;
                    peerIdContainer.style.display = 'block';
                    connectionStatus.textContent = 'âœ… ì—°ê²°ë¨! ê²Œì„ ì½”ë“œë¥¼ ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ì„¸ìš”.';
                } else {
                    // ê²ŒìŠ¤íŠ¸ëŠ” ì—°ê²° ì‹œë„ ë©”ì‹œì§€
                    connectionStatus.textContent = 'ğŸ”„ ê²Œì„ ë°© ì ‘ì† ì¤‘...';
                    
                    // í˜¸ìŠ¤íŠ¸ IDë¡œ ì—°ê²° ì‹œë„
                    const hostId = 'jorigalli-host-' + gameCode;
                    
                    try {
                        conn = peer.connect(hostId, {
                            reliable: true
                        });
                        
                        // ì—°ê²° í•¸ë“¤ëŸ¬ ì„¤ì •
                        handlePeerConnection();
                        
                        // 10ì´ˆ í›„ì—ë„ ì—°ê²°ì´ ì•ˆë˜ë©´ ì˜¤ë¥˜ í‘œì‹œ
                        setTimeout(() => {
                            if (!conn || !conn.open) {
                                toggleLoader(false);
                                connectionStatus.innerHTML = 'âŒ ê²Œì„ ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. <span style="text-decoration: underline; cursor: pointer; color: #FF6B6B;" id="retry-join">ë‹¤ì‹œ ì‹œë„</span>í•´ì£¼ì„¸ìš”.';
                                
                                document.getElementById('retry-join').addEventListener('click', () => {
                                    joinBtn.click();
                                });
                            }
                        }, 10000);
                    } catch (error) {
                        logError('ì—°ê²° ì‹œë„ ì˜¤ë¥˜:', error);
                        toggleLoader(false);
                        connectionStatus.innerHTML = 'âŒ ì—°ê²° ì‹¤íŒ¨. <span style="text-decoration: underline; cursor: pointer; color: #FF6B6B;" id="retry-join">ë‹¤ì‹œ ì‹œë„</span>í•´ì£¼ì„¸ìš”.';
                        
                        document.getElementById('retry-join').addEventListener('click', () => {
                            joinBtn.click();
                        });
                    }
                }
                
                toggleLoader(false);
            });
            
            // ì—°ê²° ì—ëŸ¬ ì‹œ
            peer.on('error', err => {
                logError('í”¼ì–´ ì—°ê²° ì˜¤ë¥˜:', err);
                
                if (err.type === 'peer-unavailable') {
                    toggleLoader(false);
                    connectionStatus.innerHTML = 'âš ï¸ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²Œì„ ì½”ë“œì…ë‹ˆë‹¤. <span style="text-decoration: underline; cursor: pointer; color: #FF6B6B;" id="retry-join">ë‹¤ì‹œ ì‹œë„</span>í•´ì£¼ì„¸ìš”.';
                    
                    if (document.getElementById('retry-join')) {
                        document.getElementById('retry-join').addEventListener('click', () => {
                            joinBtn.click();
                        });
                    }
                } else {
                    toggleLoader(false);
                    connectionStatus.innerHTML = `âŒ ì—°ê²° ì˜¤ë¥˜: ${err.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}. <span style="text-decoration: underline; cursor: pointer; color: #FF6B6B;" id="retry-connection">ë‹¤ì‹œ ì‹œë„</span>í•´ì£¼ì„¸ìš”.`;
                    
                    if (document.getElementById('retry-connection')) {
                        document.getElementById('retry-connection').addEventListener('click', () => {
                            if (isHost) {
                                createBtn.click();
                            } else {
                                joinBtn.click();
                            }
                        });
                    }
                }
            });
            
            // ì—°ê²° ìš”ì²­ ìˆ˜ì‹  ì‹œ
            peer.on('connection', connection => {
                // ì´ë¯¸ ì—°ê²°ëœ ê²½ìš° ìƒˆ ì—°ê²° ê±°ë¶€
                if (conn && conn.open) {
                    connection.close();
                    return;
                }
                
                conn = connection;
                handlePeerConnection();
            });
            
            // ì—°ê²° ì¢…ë£Œ ì‹œ
            peer.on('disconnected', () => {
                if (!peer) return;
                
                connectionStatus.textContent = 'âš ï¸ ì„œë²„ì™€ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì¬ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤...';
                connectedToPeer = false;
                
                // í”¼ì–´ê°€ ì´ë¯¸ íŒŒê´´ë˜ì—ˆëŠ”ì§€ í™•ì¸
                const isPeerDestroyed = !peer.disconnected; // peer.disconnectedê°€ falseë©´ ì´ë¯¸ íŒŒê´´ë¨
                
                // 5ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„
                setTimeout(() => {
                    if (!connectedToPeer) {
                        if (!isPeerDestroyed && peer) {
                            try {
                                peer.reconnect();
                            } catch (error) {
                                logError('ì¬ì—°ê²° ì˜¤ë¥˜:', error);
                                // ì¬ì—°ê²° ì‹¤íŒ¨ ì‹œ ìƒˆ í”¼ì–´ ìƒì„±
                                initPeerConnection();
                            }
                        } else {
                            // í”¼ì–´ê°€ ì´ë¯¸ íŒŒê´´ëœ ê²½ìš° ìƒˆë¡œ ì‹œì‘
                            initPeerConnection();
                        }
                    }
                }, 5000);
            });
            
            // ì™„ì „ ì¢…ë£Œ ì‹œ
            peer.on('close', () => {
                connectedToPeer = false;
                peer = null;
                connectionStatus.textContent = 'âŒ ì„œë²„ì™€ ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                toggleLoader(false);
            });
        }

        // í”¼ì–´ ì—°ê²° ì²˜ë¦¬ í•¨ìˆ˜
        function handlePeerConnection() {
            if (!conn) return;
            
            // ì—°ê²° ì„±ê³µ ì‹œ
            conn.on('open', () => {
                connectionStatus.textContent = 'âœ… ìƒëŒ€ë°©ê³¼ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!';
                toggleLoader(false);
                
                // ëŒ€ê¸° í™”ë©´ìœ¼ë¡œ ì „í™˜
                showScreen(waitingScreen);
                
                // ëŒ€ê¸° í™”ë©´ í…ìŠ¤íŠ¸ ì¬ì„¤ì •
                document.querySelector('.waiting-screen h2').textContent = 'ğŸ² ê²Œì„ ì¤€ë¹„ ğŸ²';
                document.querySelector('.ready-status p:nth-child(1)').innerHTML = 
                    'ë‚˜: <span id="my-ready" class="no">ì¤€ë¹„ ì•ˆë¨ âŒ</span>';
                document.querySelector('.ready-status p:nth-child(2)').innerHTML = 
                    'ìƒëŒ€ë°©: <span id="opponent-ready" class="no">ì¤€ë¹„ ì•ˆë¨ âŒ</span>';
                
                myReadyStatus = document.getElementById('my-ready');
                opponentReadyStatus = document.getElementById('opponent-ready');
                
                // ì¡°ì‘ë²• ì—…ë°ì´íŠ¸
                updateControlsForGameMode();
            });
            
            // ë°ì´í„° ìˆ˜ì‹  ì‹œ
            conn.on('data', data => {
                try {
                    handleGameData(data);
                } catch (error) {
                    logError('ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                }
            });
            
            // ì—°ê²° ì¢…ë£Œ ì‹œ
            conn.on('close', () => {
                connectionStatus.textContent = 'âŒ ìƒëŒ€ë°©ê³¼ì˜ ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                
                // ê²Œì„ ì¤‘ì´ì—ˆë‹¤ë©´ ë©”ì‹œì§€ í‘œì‹œ
                if (gameStarted) {
                    showMessage('âš ï¸ ìƒëŒ€ë°©ê³¼ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤!', 3000);
                }
                
                // ì ‘ì† í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                setTimeout(() => {
                    showScreen(connectionScreen);
                    
                    // ê²Œì„ ì´ˆê¸°í™”
                    resetGame();
                }, 3000);
            });
            
            // ì—°ê²° ì—ëŸ¬ ì‹œ
            conn.on('error', err => {
                logError('ì—°ê²° ì˜¤ë¥˜:', err);
                connectionStatus.innerHTML = `âŒ ì—°ê²° ì˜¤ë¥˜: ${err.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}. <span style="text-decoration: underline; cursor: pointer; color: #FF6B6B;" id="retry-connection">ë‹¤ì‹œ ì‹œë„</span>í•´ì£¼ì„¸ìš”.`;
                
                document.getElementById('retry-connection').addEventListener('click', () => {
                    if (isHost) {
                        createBtn.click();
                    } else {
                        joinBtn.click();
                    }
                });
                
                toggleLoader(false);
            });
        }

        // ë°ì´í„° ì „ì†¡ í•¨ìˆ˜ (ì˜¨ë¼ì¸ ëª¨ë“œìš©)
        function sendGameData(type, data) {
            if (!conn || !conn.open || gameMode !== 'online') return;
            
            try {
                conn.send({
                    type,
                    data
                });
            } catch (error) {
                logError('ë°ì´í„° ì „ì†¡ ì˜¤ë¥˜:', error);
                
                // ì—°ê²°ì´ ëŠì–´ì§„ ê²½ìš°
                if (error.toString().includes('socket is closed')) {
                    handleConnectionLost();
                }
            }
        }
        
        // ì—°ê²° ëŠê¹€ ì²˜ë¦¬ í•¨ìˆ˜
        function handleConnectionLost() {
            if (gameMode === 'online') {
                showMessage('âš ï¸ ìƒëŒ€ë°©ê³¼ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.', 3000);
                
                // 5ì´ˆ í›„ ë©”ì¸ í™”ë©´ìœ¼ë¡œ
                setTimeout(() => {
                    resetGame();
                    showScreen(connectionScreen);
                    connectionStatus.textContent = 'âŒ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                }, 5000);
            }
        }

        // ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
        function sendChatMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            if (gameMode === 'ai') {
                // AI ê²Œì„ì—ì„œëŠ” AI ì‘ë‹µ
                addChatMessage(message, true);
                chatInput.value = '';
                
                // AI ì‘ë‹µ (ì•½ê°„ì˜ ì§€ì—° í›„)
                setTimeout(() => {
                    const aiResponses = [
                        "ì¬ë¯¸ìˆê²Œ í”Œë ˆì´í•˜ê³  ìˆë‚˜ìš”? ğŸ˜Š",
                        "ì¢‹ì€ ê²Œì„ì´ë„¤ìš”! ğŸ®",
                        "í–‰ìš´ì„ ë¹•ë‹ˆë‹¤! ğŸ€",
                        "ì˜¤ëŠ˜ ì»¨ë””ì…˜ì´ ì¢‹ì•„ìš”! ğŸ‘",
                        "ì¢… ì¹˜ê¸° ì¤€ë¹„ ì™„ë£Œ! ğŸ””",
                        "ê³¼ì¼ 5ê°œ ëˆˆì—¬ê²¨ë³´ê³  ìˆì–´ìš”! ğŸ“",
                        "ì¢‹ì€ ì¹´ë“œê°€ ë‚˜ì˜¤ê¸¸! ğŸƒ",
                        "ì¬ë¯¸ìˆê²Œ ë†€ì•„ìš”! ğŸ˜„",
                        "ì¢‹ì€ ê²½ê¸°ì˜ˆìš”! â­",
                        "í™”ì´íŒ…! ğŸ’ª"
                    ];
                    
                    const randomResponse = aiResponses[Math.floor(Math.random() * aiResponses.length)];
                    addChatMessage(randomResponse, false);
                }, 1000 + Math.random() * 1000);
            } else if (gameMode === 'localMulti') {
                // ë¡œì»¬ ë©€í‹°í”Œë ˆì´ì–´ì—ì„œëŠ” í”Œë ˆì´ì–´ ë©”ì‹œì§€ í‘œì‹œ
                const playerName = currentPlayer === 1 ? "ğŸŸ¢ í”Œë ˆì´ì–´ 1" : "ğŸ”µ í”Œë ˆì´ì–´ 2";
                addChatMessage(`${playerName}: ${message}`, true);
                chatInput.value = '';
            } else if (gameMode === 'online' && conn && conn.open) {
                // ì˜¨ë¼ì¸ í”Œë ˆì´ì—ì„œ ë©”ì‹œì§€ ì „ì†¡
                addChatMessage(message, true);
                sendGameData('chat', { message });
                chatInput.value = '';
            } else {
                showMessage('âš ï¸ ì±„íŒ…ì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.', 2000);
            }
        }

        // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
        function addChatMessage(message, isSent) {
            const messageEl = document.createElement('div');
            messageEl.className = `chat-message ${isSent ? 'sent' : 'received'}`;
            messageEl.textContent = message;
            
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ê²Œì„ ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜ (ì˜¨ë¼ì¸ ëª¨ë“œìš©)
        function handleGameData(data) {
            if (!data || !data.type) return;
            
            const { type, data: gameData } = data;
            console.log(`ë°ì´í„° ìˆ˜ì‹ : ${type}`, gameData);
            
            switch (type) {
                case 'ready':
                    // ìƒëŒ€ë°© ì¤€ë¹„ ìƒíƒœ ì—…ë°ì´íŠ¸
                    opponentReady = gameData.ready;
                    opponentReadyStatus.textContent = opponentReady ? 'ì¤€ë¹„ ì™„ë£Œ âœ…' : 'ì¤€ë¹„ ì•ˆë¨ âŒ';
                    opponentReadyStatus.className = opponentReady ? 'yes' : 'no';
                    
                    // ì–‘ìª½ ëª¨ë‘ ì¤€ë¹„ ì™„ë£Œì¼ ê²½ìš° ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
                    if (playerReady && opponentReady) {
                        if (isHost) {
                            startCountdown();
                        }
                    }
                    break;
                
                case 'init-decks':
                    // ë± ì´ˆê¸°í™” (ê²ŒìŠ¤íŠ¸ í”Œë ˆì´ì–´ê°€ í˜¸ìŠ¤íŠ¸ë¡œë¶€í„° ë± ì •ë³´ ë°›ìŒ)
                    if (gameData.playerDeck && gameData.playerDeck.length > 0) {
                        playerDeck = gameData.playerDeck;
                        console.log(`ìƒëŒ€ë°©ìœ¼ë¡œë¶€í„° ë‚´ ë± ìˆ˜ì‹ : ${playerDeck.length}ì¥`);
                    } else {
                        console.error("ë°›ì€ playerDeckì´ ë¹„ì–´ìˆê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤");
                    }
                    
                    if (gameData.opponentDeck && gameData.opponentDeck.length > 0) {
                        opponentDeck = gameData.opponentDeck;
                        console.log(`ìƒëŒ€ë°©ìœ¼ë¡œë¶€í„° ìƒëŒ€ ë± ìˆ˜ì‹ : ${opponentDeck.length}ì¥`);
                    } else {
                        console.error("ë°›ì€ opponentDeckì´ ë¹„ì–´ìˆê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤");
                    }
                    
                    // ë±ì´ ë¹„ì–´ìˆìœ¼ë©´ ë¡œì»¬ì—ì„œ ìƒì„±
                    if (playerDeck.length === 0 || opponentDeck.length === 0) {
                        console.warn("ë°›ì€ ë±ì´ ë¹„ì–´ìˆì–´ ë¡œì»¬ì—ì„œ ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤");
                        createDecks();
                    }
                    
                    updateCardCounts();
                    break;
                
                case 'countdown':
                    // ì¹´ìš´íŠ¸ë‹¤ìš´ í‘œì‹œ
                    if (typeof gameData.count === 'number') {
                        showCountdown(gameData.count);
                        
                        // 0ì¼ ë•Œ ê²Œì„ ì‹œì‘
                        if (gameData.count === 0) {
                            startGame();
                        }
                    }
                    break;
                
                case 'play-card':
                    // ìƒëŒ€ë°© ì¹´ë“œ ì²˜ë¦¬
                    if (gameData.card) {
                        handleOpponentPlayCard(gameData.card);
                    }
                    break;
                
                case 'ring-bell':
                    // ìƒëŒ€ë°© ì¢… ì¹˜ê¸° ì²˜ë¦¬
                    if (typeof gameData.isValid === 'boolean') {
                        handleOpponentRingBell(gameData.isValid);
                    }
                    break;
                
                case 'chat':
                    // ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ
                    if (gameData.message) {
                        addChatMessage(gameData.message, false);
                    }
                    break;
                
                case 'game-over':
                    // ê²Œì„ ì¢…ë£Œ ì²˜ë¦¬
                    gameStarted = false;
                    
                    if (gameData.isWinner) {
                        showMessage('ğŸ‰ ê²Œì„ ìŠ¹ë¦¬! ğŸ‰', 5000);
                    } else {
                        showMessage('ğŸ˜¢ ê²Œì„ íŒ¨ë°°! ğŸ˜¢', 5000);
                    }
                    
                    // 3ì´ˆ í›„ ëŒ€ê¸° í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    setTimeout(() => {
                        // ì¤€ë¹„ ìƒíƒœ ì´ˆê¸°í™”
                        playerReady = false;
                        opponentReady = false;
                        myReadyStatus.textContent = 'ì¤€ë¹„ ì•ˆë¨ âŒ';
                        myReadyStatus.className = 'no';
                        opponentReadyStatus.textContent = 'ì¤€ë¹„ ì•ˆë¨ âŒ';
                        opponentReadyStatus.className = 'no';
                        readyBtn.textContent = 'âœ… ì¤€ë¹„ ì™„ë£Œ';
                        
                        // í™œì„± ì¹´ë“œ ì œê±°
                        playerActiveCardContainer.innerHTML = '';
                        opponentActiveCardContainer.innerHTML = '';
                        
                        // ëŒ€ê¸° í™”ë©´ìœ¼ë¡œ ì „í™˜
                        showScreen(waitingScreen);
                    }, 5000);
                    break;
                
                default:
                    console.warn('ì•Œ ìˆ˜ ì—†ëŠ” ë°ì´í„° íƒ€ì…:', type);
            }
        }

        // ê²Œì„ ë¦¬ì…‹ í•¨ìˆ˜
        function resetGame() {
            playerDeck = [];
            opponentDeck = [];
            playerActiveCard = null;
            opponentActiveCard = null;
            playerReady = false;
            opponentReady = false;
            gameStarted = false;
            isMyTurn = false;
            currentPlayer = 1;
            
            // AI í„´ íƒ€ì´ë¨¸ ì •ë¦¬
            if (aiTurnTimeout) {
                clearTimeout(aiTurnTimeout);
                aiTurnTimeout = null;
            }
            
            // ì¹´ìš´íŠ¸ë‹¤ìš´ ì •ë¦¬
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            // UI ì´ˆê¸°í™”
            playerActiveCardContainer.innerHTML = '';
            opponentActiveCardContainer.innerHTML = '';
            
            if (myReadyStatus) {
                myReadyStatus.textContent = 'ì¤€ë¹„ ì•ˆë¨ âŒ';
                myReadyStatus.className = 'no';
            }
            
            if (opponentReadyStatus) {
                opponentReadyStatus.textContent = 'ì¤€ë¹„ ì•ˆë¨ âŒ';
                opponentReadyStatus.className = 'no';
            }
            
            if (readyBtn) {
                readyBtn.textContent = 'âœ… ì¤€ë¹„ ì™„ë£Œ';
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.addEventListener('DOMContentLoaded', () => {
            // ìƒˆ ê²Œì„ ë§Œë“¤ê¸° ë²„íŠ¼
            createBtn.addEventListener('click', () => {
                isHost = true;
                gameMode = 'online';
                
                // 3ìë¦¬ ê²Œì„ ì½”ë“œ ìƒì„±
                gameCode = generateGameCode();
                
                toggleLoader(true);
                connectionStatus.textContent = 'ğŸ”„ ê²Œì„ ë°© ìƒì„± ì¤‘...';
                
                // PeerJS ì—°ê²° ì´ˆê¸°í™”
                initPeerConnection();
            });
            
            // ê²Œì„ ì°¸ì—¬ ë²„íŠ¼
            joinBtn.addEventListener('click', () => {
                const code = joinId.value.trim();
                if (!code || code.length !== 3 || !/^\d+$/.test(code)) {
                    connectionStatus.textContent = 'âš ï¸ ìœ íš¨í•œ 3ìë¦¬ ê²Œì„ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                    joinId.focus();
                    return;
                }
                
                isHost = false;
                gameMode = 'online';
                gameCode = code;
                
                toggleLoader(true);
                connectionStatus.textContent = 'ğŸ”„ ê²Œì„ ë°© ì ‘ì† ì¤‘...';
                
                // PeerJS ì—°ê²° ì´ˆê¸°í™”
                initPeerConnection();
                
                // í”¼ì–´ ì—°ê²° ì„±ê³µ í›„ í˜¸ìŠ¤íŠ¸ì— ì—°ê²° ì‹œë„
                const connectionHandler = () => {
                    console.log("í”¼ì–´ open í•¸ë“¤ëŸ¬ ì‹¤í–‰");
                    
                    if (!peer || !peer.id) {
                        console.error("í”¼ì–´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŒ");
                        return;
                    }
                    
                    // í˜¸ìŠ¤íŠ¸ IDë¡œ ì—°ê²° ì‹œë„
                    const hostId = 'jorigalli-host-' + gameCode;
                    console.log(`í˜¸ìŠ¤íŠ¸ IDì— ì—°ê²° ì‹œë„: ${hostId}`);
                    
                    try {
                        conn = peer.connect(hostId, {
                            reliable: true,
                            metadata: { gameCode }
                        });
                        
                        if (!conn) {
                            console.error("ì—°ê²° ê°ì²´ ìƒì„± ì‹¤íŒ¨");
                            return;
                        }
                        
                        // ì—°ê²° í•¸ë“¤ëŸ¬ ì„¤ì •
                        handlePeerConnection();
                        
                        // 10ì´ˆ í›„ì—ë„ ì—°ê²°ì´ ì•ˆë˜ë©´ ì˜¤ë¥˜ í‘œì‹œ
                        setTimeout(() => {
                            if (!conn || !conn.open) {
                                console.warn("ì—°ê²° ì‹œê°„ ì´ˆê³¼");
                                toggleLoader(false);
                                connectionStatus.innerHTML = 'âš ï¸ ê²Œì„ ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. <span style="text-decoration: underline; cursor: pointer; color: #FF6B6B;" id="retry-join">ë‹¤ì‹œ ì‹œë„</span>í•´ì£¼ì„¸ìš”.';
                                
                                const retryBtn = document.getElementById('retry-join');
                                if (retryBtn) {
                                    retryBtn.addEventListener('click', () => {
                                        joinBtn.click();
                                    });
                                }
                            }
                        }, 10000);
                    } catch (error) {
                        console.error('ì—°ê²° ì‹œë„ ì˜¤ë¥˜:', error);
                        toggleLoader(false);
                        connectionStatus.innerHTML = 'âŒ ì—°ê²° ì‹¤íŒ¨. <span style="text-decoration: underline; cursor: pointer; color: #FF6B6B;" id="retry-join">ë‹¤ì‹œ ì‹œë„</span>í•´ì£¼ì„¸ìš”.';
                        
                        const retryBtn = document.getElementById('retry-join');
                        if (retryBtn) {
                            retryBtn.addEventListener('click', () => {
                                joinBtn.click();
                            });
                        }
                    }
                };
                
                // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡ (ì—°ê²°ì´ ì„±ê³µí•˜ë©´ í˜¸ì¶œë¨)
                if (peer) {
                    peer.on('open', connectionHandler);
                }
            });
            
            // AI ê²Œì„ ë²„íŠ¼
            localPlayBtn.addEventListener('click', () => {
                startAIGame();
                
                // ì¦‰ì‹œ ë± ìƒì„±
                createDecks();
                console.log(`AI ê²Œì„: ì´ˆê¸° ì¹´ë“œ ìˆ˜ - í”Œë ˆì´ì–´: ${playerDeck.length}, AI: ${opponentDeck.length}`);
            });
            
            // ë¡œì»¬ ë©€í‹°í”Œë ˆì´ì–´ ë²„íŠ¼
            localMultiBtn.addEventListener('click', () => {
                startLocalMultiGame();
                
                // ì¦‰ì‹œ ë± ìƒì„±
                createDecks();
                console.log(`ë¡œì»¬ ë©€í‹°: ì´ˆê¸° ì¹´ë“œ ìˆ˜ - í”Œë ˆì´ì–´1: ${opponentDeck.length}, í”Œë ˆì´ì–´2: ${playerDeck.length}`);
            });
            
            // ì¤€ë¹„ ë²„íŠ¼
            readyBtn.addEventListener('click', () => {
                if (gameMode === 'localMulti') {
                    // ë¡œì»¬ ë©€í‹°í”Œë ˆì´ì–´ì—ì„œëŠ” ë‘ í”Œë ˆì´ì–´ ëª¨ë‘ ì¤€ë¹„ì™„ë£Œë¡œ ì„¤ì •
                    playerReady = true;
                    opponentReady = true;
                    myReadyStatus.textContent = 'ì¤€ë¹„ ì™„ë£Œ âœ…';
                    myReadyStatus.className = 'yes';
                    opponentReadyStatus.textContent = 'ì¤€ë¹„ ì™„ë£Œ âœ…';
                    opponentReadyStatus.className = 'yes';
                    
                    // ë°”ë¡œ ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
                    startCountdown();
                } else {
                    // ì˜¨ë¼ì¸/AI ê²Œì„ì—ì„œëŠ” ìì‹ ì˜ ì¤€ë¹„ ìƒíƒœë§Œ í† ê¸€
                    playerReady = !playerReady;
                    myReadyStatus.textContent = playerReady ? 'ì¤€ë¹„ ì™„ë£Œ âœ…' : 'ì¤€ë¹„ ì•ˆë¨ âŒ';
                    myReadyStatus.className = playerReady ? 'yes' : 'no';
                    readyBtn.textContent = playerReady ? 'ğŸ”„ ì¤€ë¹„ ì·¨ì†Œ' : 'âœ… ì¤€ë¹„ ì™„ë£Œ';
                    
                    // ì˜¨ë¼ì¸ ëª¨ë“œì—ì„œë§Œ ìƒëŒ€ë°©ì—ê²Œ ì „ì†¡
                    if (gameMode === 'online' && conn && conn.open) {
                        sendGameData('ready', { ready: playerReady });
                    }
                    
                    // AI ê²Œì„ì—ì„œëŠ” í”Œë ˆì´ì–´ê°€ ì¤€ë¹„ë˜ë©´ ë°”ë¡œ ê²Œì„ ì‹œì‘
                    if (gameMode === 'ai' && playerReady) {
                        startCountdown();
                    }
                    
                    // ì˜¨ë¼ì¸ ëª¨ë“œì—ì„œ ì–‘ìª½ ëª¨ë‘ ì¤€ë¹„ ì™„ë£Œì¼ ê²½ìš° ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
                    if (gameMode === 'online' && playerReady && opponentReady && isHost) {
                        startCountdown();
                    }
                }
            });
            
            // ë’¤ë¡œê°€ê¸° ë²„íŠ¼
            backBtn.addEventListener('click', () => {
                // ê²Œì„ ì´ˆê¸°í™”
                resetGame();
                
                // ì—°ê²° ì¢…ë£Œ
                if (conn) {
                    try {
                        conn.close();
                    } catch (error) {
                        // ë¬´ì‹œ
                    }
                    conn = null;
                }
                
                if (peer) {
                    try {
                        peer.destroy();
                    } catch (error) {
                        // ë¬´ì‹œ
                    }
                    peer = null;
                }
                
                // ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                showScreen(connectionScreen);
            });
            
            // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
            document.addEventListener('keydown', (e) => {
                if (!gameStarted) return;
                
                if (gameMode === 'localMulti') {
                    // ë¡œì»¬ ë©€í‹°í”Œë ˆì´ì–´ í‚¤ ì²˜ë¦¬
                    if (e.key === 'w' || e.key === 'W') {
                        // í”Œë ˆì´ì–´ 1 ì¹´ë“œ ë‚´ê¸°
                        playCard(1);
                    } else if (e.key === 'ArrowUp') {
                        // í”Œë ˆì´ì–´ 2 ì¹´ë“œ ë‚´ê¸°
                        playCard(2);
                    } else if (e.key === ' ' || e.code === 'Space') {
                        // í”Œë ˆì´ì–´ 1 ì¢… ì¹˜ê¸°
                        e.preventDefault();
                        ringBell(1);
                    } else if (e.key === 'Enter') {
                        // í”Œë ˆì´ì–´ 2 ì¢… ì¹˜ê¸°
                        e.preventDefault();
                        ringBell(2);
                    }
                } else {
                    // ì˜¨ë¼ì¸/AI ê²Œì„ í‚¤ ì²˜ë¦¬
                    if (e.key === 'ArrowUp') {
                        // ì¹´ë“œ ë‚´ê¸°
                        playCard();
                    } else if (e.key === ' ' || e.code === 'Space') {
                        // ì¢… ì¹˜ê¸°
                        e.preventDefault();
                        ringBell();
                    }
                }
            });
            
            // ì¢… í´ë¦­ ì´ë²¤íŠ¸
            bell.addEventListener('click', () => {
                if (!gameStarted) return;
                
                if (gameMode === 'localMulti') {
                    // ë¡œì»¬ ë©€í‹°í”Œë ˆì´ì–´ì—ì„œëŠ” í˜„ì¬ í”Œë ˆì´ì–´ê°€ ì¢… ì¹˜ê¸°
                    ringBell(currentPlayer);
                } else {
                    // ì˜¨ë¼ì¸/AI ê²Œì„ì—ì„œëŠ” í”Œë ˆì´ì–´ê°€ ì¢… ì¹˜ê¸°
                    ringBell();
                }
            });
            
            // ì±„íŒ… í† ê¸€ ë²„íŠ¼
            chatToggle.addEventListener('click', () => {
                chatContainer.classList.toggle('open');
                // ì±„íŒ…ì°½ ì—´ë¦´ ë•Œ ì¸í’‹ì— í¬ì»¤ìŠ¤
                if (chatContainer.classList.contains('open')) {
                    chatInput.focus();
                }
            });
            
            // ì±„íŒ… ì „ì†¡ ë²„íŠ¼
            sendChatBtn.addEventListener('click', sendChatMessage);
            
            // ì±„íŒ… ì…ë ¥ í•„ë“œ ì—”í„° í‚¤
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
            
            // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì—°ê²° ì •ë¦¬
            window.addEventListener('beforeunload', () => {
                if (conn) {
                    try {
                        conn.close();
                    } catch (e) {}
                    conn = null;
                }
                
                if (peer) {
                    try {
                        peer.destroy();
                    } catch (e) {}
                    peer = null;
                }
                
                // íƒ€ì´ë¨¸ ì •ë¦¬
                if (aiTurnTimeout) {
                    clearTimeout(aiTurnTimeout);
                }
                
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                }
            });
            
            // ê²Œì„ ì½”ë“œ ì…ë ¥ í•„ë“œ ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•˜ë„ë¡
            joinId.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, '').substring(0, 3);
            });
        });
    </script>
</body>
</html>
